<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
<link href="css/dark-hive/jquery-ui-1.10.3.custom.min.css" rel="stylesheet" />

<style>
	
	table tr td{
		text-align: center;
		font-family: "Arial",Georgia,Serif;		
	}	
	
	table thead tr th{
		text-align: center;
		font-family: "Arial",Georgia,Serif;		
	}	
	
	h1,h2{
		font-family: "Arial",Georgia,Serif;		
	}
	
	h4,h5,div,table{
		padding:0em;
		margin:0em;
	}
	.seleccionada{
		background:blue;
		color:white;
	}

	.ui-button-text{
		padding:.3em !important;
	}
	
	#respuesta table tbody tr.ui-widget-header{
		font-family: "Arial",Georgia,Serif !important;		
		font-weight: normal !important;
	}
	
.nueva {
	-moz-box-shadow:inset 0px 1px 0px 0px #cae3fc;
	-webkit-box-shadow:inset 0px 1px 0px 0px #cae3fc;
	box-shadow:inset 0px 1px 0px 0px #cae3fc;
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #79bbff), color-stop(1, #4197ee) );
	background:-moz-linear-gradient( center top, #79bbff 5%, #4197ee 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#79bbff', endColorstr='#4197ee');
	background-color:#79bbff;
	-moz-border-radius:6px;
	-webkit-border-radius:6px;
	border-radius:6px;
	border:1px solid #469df5;
	display:inline-block;
	color:#ffffff;
	font-family:arial;
	font-size:7px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:1px 1px 0px #287ace;
}.classname:hover {
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #4197ee), color-stop(1, #79bbff) );
	background:-moz-linear-gradient( center top, #4197ee 5%, #79bbff 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#4197ee', endColorstr='#79bbff');
	background-color:#4197ee;
}.classname:active {
	position:relative;
	top:1px;
}
	
.completada {
	-moz-box-shadow:inset 0px 1px 0px 0px #a4e271;
	-webkit-box-shadow:inset 0px 1px 0px 0px #a4e271;
	box-shadow:inset 0px 1px 0px 0px #a4e271;
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #89c403), color-stop(1, #77a809) );
	background:-moz-linear-gradient( center top, #89c403 5%, #77a809 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#89c403', endColorstr='#77a809');
	background-color:#89c403;
	-moz-border-radius:6px;
	-webkit-border-radius:6px;
	border-radius:6px;
	border:1px solid #74b807;
	display:inline-block;
	color:#ffffff;
	font-family:arial;
	font-size:7px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:1px 1px 0px #528009;
}.classname:hover {
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #77a809), color-stop(1, #89c403) );
	background:-moz-linear-gradient( center top, #77a809 5%, #89c403 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#77a809', endColorstr='#89c403');
	background-color:#77a809;
}.classname:active {
	position:relative;
	top:1px;
}

.pendiente {
	-moz-box-shadow:inset 0px 1px 0px 0px #fff6af;
	-webkit-box-shadow:inset 0px 1px 0px 0px #fff6af;
	box-shadow:inset 0px 1px 0px 0px #fff6af;
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #ffec64), color-stop(1, #ffab23) );
	background:-moz-linear-gradient( center top, #ffec64 5%, #ffab23 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffec64', endColorstr='#ffab23');
	background-color:#ffec64;
	-moz-border-radius:6px;
	-webkit-border-radius:6px;
	border-radius:6px;
	border:1px solid #ffaa22;
	display:inline-block;
	color:#333333;
	font-family:arial;
	font-size:7px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:1px 1px 0px #ffee66;
}.classname:hover {
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #ffab23), color-stop(1, #ffec64) );
	background:-moz-linear-gradient( center top, #ffab23 5%, #ffec64 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffab23', endColorstr='#ffec64');
	background-color:#ffab23;
}.classname:active {
	position:relative;
	top:1px;
}
	
#botones label{
	font-size: .9em !important;
}

.matched_active{			
	border-style: solid;	
	border-width: 2px;
	border-color: yellow;
	// background-color: #d1ffd1 !important;	
	background-color:#fbb450;
}

.matched{			
	border-style: solid;
	border-width: 2px;
	border-color: yellow;
	background-color: rgb(253, 255, 209) !important;
}

</style>

<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui.js"></script>
<script type="text/javascript" src="js/taffy.js"></script>
<script type="text/javascript" src="js/json2.js"></script>
<!--script type="text/javascript" src="js/jquery-ui-1.10.3.custom.min.js"></script-->
<script type="text/javascript" src="js/jquery.dataTables.min.js"></script>

<script>

/**
 * Very simple way to check if a file exists on this domain.
 * Use with the jQuery library.
 *
 * Important: 	Works only on the same domain. 
 * 		Cross-domain-requests have to be done in another way (see JSONP)!
 *
 * Use: console.log(   "/data/list.json".fileExists()  );
 */
String.prototype.fileExists = function() {
	filename = this;
	
	var response = jQuery.ajax({
		url: filename,
		type: 'HEAD',
		async: false
	}).status;		
	return (response != "200") ? false : true;
}

 function isDocumentAvailable(url) {

        var fSuccess = false;
        var client = null;

        // XHR is supported by most browsers.
        // IE 9 supports it (maybe IE8 and earlier) off webserver
        // IE running pages off of disk disallows XHR unless security zones are set appropriately. Throws a security exception.
        // Workaround is to use old ActiveX control on IE (especially for older versions of IE that don't support XHR)

        // FireFox 4 supports XHR (and likely v3 as well) on web and from local disk

        // Works on Chrome, but Chrome doesn't seem to allow XHR from local disk. (Throws a security exception) No workaround known.

        // Try the ActiveX control if available
        if (client === null) {
            try {
                client = new ActiveXObject("Microsoft.XMLHTTP");
                client.open("GET", url, false);
                client.send();
            }
            catch (err) {
                // Giving up, nothing we can do
                client = null;
            }
        }

        fSuccess = Boolean(client && client.responseText);

        return fSuccess;
    }

	// Indice comienza en 1
	
		var cursor=0;
        var id_respuesta=1;
		var contestadas=0;		
		// var id_toma=1;					
        
		// Estas variables se usan para identificar el archivo con la toma
		var id_medicion;
		var codigo_auditor;
		var folio_sala;
		
        var preguntasDB;
        var seccionesDB;		
        var topicosDB;        
        var categoriasDB;									
        var preguntas_categoriasDB;											
        var itemesDB;								
        var alternativasDB;	  

		var cuestionario_valido=true;
		
		// var seleccionada='seleccionada';
		var seleccionada="ui-state-active";

	// var pathCuestionario="cuestionario.txt"
	var pathCuestionario="\\Application\\cuestionario.txt";
		
	function respuesta(id_respuesta,valor_respuesta,id_item,id_pregunta,id_categoria)
	{
		this.id_respuesta=id_respuesta;
		this.valor_respuesta=valor_respuesta;               
		this.id_item=id_item;
		this.id_pregunta=id_pregunta;	
		this.id_categoria=id_categoria;
	}	
	
	function toma(id_medicion,fecha_toma,estado_toma,id_auditor,id_sala,respuestas)
	{		
		this.id_medicion=id_medicion;
		this.fecha_toma=fecha_toma;
		this.estado_toma=estado_toma;		
		this.id_auditor=id_auditor;
		this.id_sala=id_sala;
		this.respuestas=respuestas;
	}	

	var respuestas= new Array();

	var respuestasDB= TAFFY(respuestas); 									

	// Carga de datos en los contenedores de objetos
	
	function cargar_datos()
	{				
		$('#sesion').hide(),
		$('#container').show();
		$('#botones').show();
		// $('#volver').show();
		var palabras=$('#mediciones :selected').text().split(" ");
		var cadena=palabras[1]+'/'+$('#nombre_auditor').text()+'/'+folio_sala;
		
		if(cadena.length>32)
			$('#titulo').text(cadena.substring(0,29)+'...');
		else
			$('#titulo').text(cadena);	
		// cargar_respuestas();
			$.getJSON('data/topicos.txt',function(data){					
				topicosDB=TAFFY(data);
				$.getJSON('data/secciones.txt',function(data){
					seccionesDB=TAFFY(data);
					$.getJSON('data/categorias.txt',function(data){
						categoriasDB=TAFFY(data);
						$.getJSON('data/preguntas.txt',function(data){			
							preguntasDB=TAFFY(data);	
							$.getJSON('data/preguntas_categorias.txt',function(data){
								preguntas_categoriasDB=TAFFY(data);
								$.getJSON('data/itemes.txt',function(data){
									itemesDB=TAFFY(data);
									$.getJSON('data/alternativas.txt',function(data){
										alternativasDB=TAFFY(data);	
										cursor=1;
										cargar_contenido(cursor);	
										cargar_listener(cursor);
										$('#cuestionario').dataTable({
											"sScrollY": "520px",		 		 		
											"bFilter": false,
											"bSort": false,
											"bInfo": false,
											"bPaginate": false,
											"bJQueryUI": true,
											"bAutoWidth": false, 	
											"bRetrieve": true, 											
											// "bDestroy": false, 
										});										
									});									
								});	
							});		
						});	
					});	
				});				
			});				
	}
			
	function cargar_mediciones()
	{																		
		var xmlhttp;
		if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari				
			xmlhttp=new XMLHttpRequest();				
		}
		else{// code for IE6, IE5				
			xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");				
		}
																
		xmlhttp.onreadystatechange=function(){
												
			if (xmlhttp.readyState==4 && xmlhttp.status==200)
			{									
				var data = JSON.parse(xmlhttp.responseText);											
				
				if(data.Codigo==0)
				{
					alert("Error al recuperar datos, porfavor vuelva a intentarlo más tarde.\nDetalles: "+data.Mensaje);
					return false;
				}													
				alert("Datos recuperados exitosamente. A continuación ingrese su código de auditor");
				$('#inicio').hide();
				$('#sesion').show();
				
				$(data.mediciones).each(function(key,value){	
					$('#mediciones').append("<option value='"+value.id_medicion+"' "+value.activa+">"+value.nombre_medicion+"</option>");						
				});
								
				var html="<table id='tabla_auditores' width='100%'><thead><tr><th>AUDITORES</th></tr></thead><tbody>";				
								
				$('#auditor').mousedown(function(){											
					
					if($('#codigo_auditor').val()=='')
					{
						$('#codigo_auditor').val('');						
						alert('Debe introducir un ID de auditor');
						return false;
					}
					
					$('#salas').html('<p>Cargando visitas...</p>');
					$('.ui-state-active').removeClass();
					$(this).addClass('ui-state-active');
				
					codigo_auditor=parseInt($('#codigo_auditor').val());								
				
					var xmlhttp;
					if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari				
						xmlhttp=new XMLHttpRequest();				
					}
					else{// code for IE6, IE5							
						xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");				
					}												
										
					xmlhttp.onreadystatechange=function(){												
												
						if (xmlhttp.readyState==4 && xmlhttp.status==200)
						{																	
							var data = JSON.parse(xmlhttp.responseText);	
							
							if($.isEmptyObject(data))
							{
								alert("No existen salas asignadas para este auditor");
								$('#salas').html('');
							}
							else
							{
								$('button').removeClass();
								
								if(data.Codigo==0)
								{
									alert(data.Mensaje);
									$('#salas').html('');
									return false;
								}
									
								$('#nombre_auditor').text(data.nombre_auditor);
							
								// var html="<table id='tabla_salas' border=1 width='100%'><thead><tr><th width='90%'>SALAS_AUDITOR</th><th width='10%'></th></tr></thead><tbody>";
								var html="<table id='tabla_salas' border=1 width='100%'><thead><tr><th>VISITAS</th></tr></thead><tbody>";								
								
								$(data.salas).each(function(key,value){	
									var pathToma="\\Application\\toma"+id_medicion+codigo_auditor+value.folio+".txt";
																		
									// Si la toma no existe
									// var estado="<img src='images/bubble-red-md.png' style='height:1em;width:1em' />";	
									var estado="nueva";	
									var status=0;
									// Si la toma existe en el equipo
									if(isDocumentAvailable(pathToma))			
									{
										status=status+1;
										estado="pendiente"
										// estado="<img src='images/bubble-yellow-md.png' style='height:1em;width:1em' />";																					
									}
									// Si la toma existe en la BD
									if(value.id_toma!=0)
									{
										status=status+2;
										estado="completada";
										// estado="<img src='images/bubble-green-md.png' style='height:1em;width:1em' />";											
									}
									var cadena=value.cadena;
									
									if(value.cadena=='#N/A')
										cadena=value.folio;
									
									html+="<tr><td style='padding:0em'><button style='width:370px' class='sala "+estado+"' status='"+status+"' folio_sala="+value.folio+"><label style='font-size:1.5em'>"+cadena+"<br />"+value.comuna+"<br />"+value.direccion+"</label></button></td></tr>";									
									
								});
								html+="</tbody></table>";
	
								$('#loader').hide();
								$('#salas').html(html);
							
								$('#tabla_salas').dataTable({
									"sScrollY": "350px",																			
									"bFilter": false,
									"bSort": false,
									"bInfo": false,
									"bPaginate": false,
									"bJQueryUI": true,
									"bSortClasses": false,
									"bAutoWidth": false, 	
									"bDeferRender": true,																	
								});							
								$("<div class='dataTables_filter' align='right'><label style='float:left;color:black'>buscar:</label><input id='buscar' style='float:left' /></div>").appendTo('#tabla_salas_wrapper .fg-toolbar:first');				 												

								listenerFiltro();
								
								$('.sala').mousedown(function(){
									
									folio_sala=$(this).attr('folio_sala');
									var status=parseInt($(this).attr('status'));																			
									
									pathCuestionario="\\Application\\toma"+id_medicion+codigo_auditor+folio_sala+".txt";
									
									if(isDocumentAvailable(pathCuestionario))
									{									
										$.getJSON(pathCuestionario,function(data){					
											respuestasDB=TAFFY(data.respuestas);											
											cursor=parseInt(respuestasDB().max('id_pregunta'));
										});
									}																		
									
									switch(status)
									{
										case 0:
											var opcion=confirm("La siguiente sesión:\nMedición: "+$('#mediciones :selected').text()+"\nAuditor: "+$('#nombre_auditor').text()+"\nSala: "+folio_sala+"\ncorresponde a una nueva toma en este equipo. ¿Desea iniciar esta toma?");
											if(opcion)
												cargar_datos();	
											break;
										case 1:
											var opcion=confirm("La sesión "+pathCuestionario+" corresponde a una toma pendiente en este equipo. ¿Desea cargar los datos de esta toma?");																																						
											if(opcion)
												cargar_datos();	
											break;
										case 2:
											var opcion=confirm("La sesión "+pathCuestionario+" corresponde a una toma inexistente en este equipo. Sin embargo existe en la base de datos. ¿Desea recuperar los datos de esta toma y cargarlos?");														
											if(opcion)
												cargar_datos();	
											break;												
											break;	
										case 3:
											var opcion=confirm("La sesión "+pathCuestionario+" corresponde a una toma completada en este equipo y enviada a la base de datos. ¿Desea cargar los datos de esta toma?");														
											if(opcion)
												cargar_datos();	
											break;																								
									}									
								});
							}																										
						}
						setTimeout(function() { 
							if(xmlhttp.readyState!=4)
							{
								xmlhttp.abort(); 
								alert("Excede tiempo de respuesta, verifique que la conexión 3g esté activada. Si la conexión está activada intente con una mejor señal"); 
								return false;
							}
							else
								return true;
						},60000);						
					}						
					id_medicion=$('#mediciones').val();
					xmlhttp.open("GET","http://200.29.139.244/REDBULL/php/cargar_maestra.php?caso=2&codigo_auditor='"+codigo_auditor+"'&id_medicion='"+id_medicion+"'",true);
					xmlhttp.send();						
				});						
			}
			setTimeout(function() { 
				if(xmlhttp.readyState!=4)
				{
					xmlhttp.abort(); 
					alert("Excede tiempo de respuesta, verifique que la conexión 3g esté activada. Si la conexión está activada intente con una mejor señal"); 
					return false;
				}
				else
					return true;
			},60000);
		}
		xmlhttp.open("GET",'http://200.29.139.244/REDBULL/php/cargar_maestra.php?caso=1',true);
		xmlhttp.send();					
	}
	
	function cargar_contenido(id_pregunta)
	{					     					
        // Filtrar preguntas por id_pregunta segun cursor actual		
        preguntasDB().filter({'id_pregunta':id_pregunta}).each(function (r1) { 

            seccionesDB().filter({'id_seccion':r1.id_seccion}).each(function (r2) { 

                topicosDB().filter({'id_topico':r2.id_topico}).each(function (r3) { 
				
					$('#topico').html("<h5 style='color:"+r3.color_letra+"'>"+r3.numero_topico+'. '+r3.nombre_topico+"<h5>");
					$('#topico').css('background-color',r3.color_topico);
					
					$('#seccion').html("<h5>"+r3.numero_topico+"."+r2.numero_seccion+" "+r2.nombre_seccion+"</h5>");
                    $('#seccion').css('background-color',r2.color_seccion);										                

					$('#pregunta').html("<h5 style='padding:0em'>"+r3.numero_topico+'.'+r2.numero_seccion+'.'+r1.numero_pregunta+' '+r1.contenido_pregunta+"</h5>");					
					
                    switch(parseInt(r1.tipo))
                    {
                        case 1:// Tipo alternativa => cargar las alternativas para esta pregunta
                            // Verificar si existen categorias para esta pregunta	                                                       
							
							var tiene_categoria=(preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).count()>0);
																					
							switch(parseInt(r1.tipo2))
							{								
								case 1: // Tipo disyuntiva
									if(tiene_categoria)									
									{                      																		
										var html="<table id='tabla_alternativas"+cursor+"' width='100%' border='1' align='left'>";										
										
										preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {																																					
											
											categoriasDB().filter({'id_categoria':r5.id_categoria},{'estado_categoria':true}).each(function (r6) {
																				
											// alert(JSON.stringify(r6));
											
											var cont=0;
											
											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r9){												
												cont++;
											});			
											
											html=html+"<tr><td width='10%' style='text-align:left' rowspan='"+cont+"'>"+r6.nombre_categoria+"</td>";											
											var cont=1;

											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r7) {

												itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {

													if(cont===1)
														html=html+"<td width='90%' style='text-align:left'><input type='radio' id='radio"+cont+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='radio"+cursor+r5.id_categoria+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";                                                                                                
													else                                                                                                
														html=html+"<tr id='"+r8.id_item+"'><td item='"+r7.id_item+"' style='text-align:left'><input type='radio' id='radio"+cont+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='radio"+cursor+r5.id_categoria+"' value='"+r5.id_categoria+r8.id_item+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";										
												});	
												cont++;
											});																																	
										});			
									});	
									// Aqui se agrega la alternativa adicional "no existen ubiaciones adicionales"
									alternativasDB().filter({'id_categoria':null},{'id_pregunta':id_pregunta}).each(function (r7) {												
										itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {                                                                                              
											html=html+"<tr id='"+r8.id_item+"'><td item='"+r7.id_item+"' colspan='2' style='text-align:left'><input type='radio' id='radio"+cont+"' pregunta='"+cursor+"' categoria='null' item='"+r7.id_item+"' name='radio"+cursor+"null' value='null"+r8.id_item+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";										
										});	
									});		
									html=html+"</table>";                         
									}
									else
									{
										// Si no existen categorias para esta pregunta, cargar directamente las alternativas
										var html="<table id='tabla_alternativas"+cursor+"' width='100%' border='1' align='left'>";
										var cont=1;
										alternativasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {					
												cont++;
												itemesDB().filter({'id_item':r5.id_item}).each(function (r6) {									
													html=html+"<tr><td id='"+r6.id_item+"' style='text-align:left'><input type='radio' id='radio"+cont+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r5.id_item+"' name='radio"+cursor+r5.id_categoria+"' value='"+r6.id_item+"' /><label style='font-size:0.9em'>"+r6.nombre_item+"</label></td></tr>";										
												});															
										});		
										html=html+"</table>";									
									}					
									// $('#seccion'+r3.id_topico+r2.id_seccion).dataTable().fnAddData([html]);
									$('#respuesta').html(html);   															
									
									// Si existen respuestas buscar las respuestas correspondiente a la pregunta actual y cargarlas
																		
									respuestasDB().filter({'id_pregunta':id_pregunta}).each(function (r10) {											
										$('[name=radio'+id_pregunta+r10.id_categoria+']').filter('[categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').prop('checked', true);
										$('[name=radio'+id_pregunta+r10.id_categoria+']').filter('[categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').parent().addClass(seleccionada);
									});										
									
									break;
								case 2: // Tipo conjuntiva									
									if(tiene_categoria)
									{                         										
										var html="<table id='tabla_alternativas"+cursor+"' width='100%' border='1' align='left'>";

										preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {

											categoriasDB().filter({'id_categoria':r5.id_categoria}).each(function (r6) {
																				
											var cont=0;
											
											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r9){
												cont++;
											});											
											html=html+"<tr><td width='30%' style='text-align:left' rowspan='"+cont+"'>"+r6.nombre_categoria+"</td>";											
											var cont=1;

											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r7) {

											itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {

												if(cont===1)
													html=html+"<td width='70%' style='text-align:left'><input type='checkbox' id='radio"+cont+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='checkbox' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";                                                                                                
												else                                                                                                
													html=html+"<tr width='50%' id='"+r8.id_item+"'><td item='"+r7.id_item+"' style='text-align:left'><input type='checkbox' id='radio"+cont+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='checkbox' value='"+r5.id_categoria+r8.id_item+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";										
											});	
											cont++;
											});										
										});			
									});										
									// Aqui se agrega la alternativa adicional "no existen ubiaciones adicionales"									
									alternativasDB().filter({'id_categoria':null},{'id_pregunta':id_pregunta}).each(function (r7) {												
										itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {  																				
											html=html+"<tr id='"+r8.id_item+"'><td item='"+r7.id_item+"' colspan='2' style='text-align:left'><input type='radio' id='radio"+cont+"' pregunta='"+cursor+"' categoria='null' item='"+r7.id_item+"' name='radio"+cursor+"null' value='null"+r8.id_item+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";										
										});	
									});										
									html=html+"</table>";                         
									}
									else
									{
										// Si no existen categorias para esta pregunta, cargar directamente las alternativas
										var html="<table id='tabla_alternativas"+cursor+"' width='100%' border='1' align='left'>";
										var cont=1;
										alternativasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {					
											cont++;
											itemesDB().filter({'id_item':r5.id_item}).each(function (r6) {									
												if(r6.id_item=='34')																
													html=html+"<tr><td id='"+r6.id_item+"' colspan='2' style='text-align:left'><input type='radio' id='radio"+cont+"' pregunta='"+cursor+"' categoria='null' item='"+r5.id_item+"' name='radio"+cursor+"null' value='null"+r6.id_item+"' /><label style='font-size:0.9em'>"+r6.nombre_item+"</label></td></tr>";										
												else
													html=html+"<tr><td id='"+r6.id_item+"' style='text-align:left'><input type='checkbox' id='radio"+cont+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r5.id_item+"' name='checkbox' value='"+r6.id_item+"' /><label style='font-size:0.9em'>"+r6.nombre_item+"</label></td></tr>";										
											});															
										});		
										html=html+"</table>";									
									}  															
									// $('#seccion'+r3.id_topico+r2.id_seccion).dataTable().fnAddData([html]);
									$('#respuesta').html(html);
									// Si existen respuestas buscar las respuestas correspondientes a la pregunta actual y cargarlas
																		
									respuestasDB().filter({'id_pregunta':id_pregunta}).each(function (r10) {	
										// console.log(r10);				
										if($.inArray(r10.id_item,["33","34","35","37"])==-1)
										{
											$('[name=checkbox]').filter('[pregunta='+id_pregunta+'][categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').prop('checked', true);
											$('[name=checkbox]').filter('[pregunta='+id_pregunta+'][categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').parent().addClass(seleccionada);
										}
										else
										{											
											$("[name='radio"+cursor+"null']").filter('[pregunta='+id_pregunta+'][categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').prop('checked', true);
											$("[name='radio"+cursor+"null']").filter('[pregunta='+id_pregunta+'][categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').parent().addClass(seleccionada);
										}
									});																																		
									break;																					                                                     
								case 3: // Tipo conjuntiva con valor	
									var html="";
									
									if(tiene_categoria)
									{                         													
										html=html+"<div><table id='tabla_alternativas"+cursor+"' width='100%' border='1' align='left'></div>";

										preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {

											categoriasDB().filter({'id_categoria':r5.id_categoria}).each(function (r6) {
																				
											var cont=0;
											
											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r9){
												cont++;
											});											
											html=html+"<tr><td width='20%' style='text-align:left' rowspan='"+cont+"'>"+r6.nombre_categoria+"</td>";											
											var cont=1;

											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r7) {

											itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {

												if(cont===1)
													html=html+"<td width='50%' style='text-align:left'><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td><td width='20%'><input id='valor"+cursor+r5.id_categoria+r7.id_item+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='input"+r5.id_categoria+r7.id_item+"' class='valor' size='4' /></td></tr>";                                                                                                
												else                                                                                                
													html=html+"<tr width='50%' id='"+r8.id_item+"'><td item='"+r7.id_item+"' style='text-align:left'><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td><td width='20%'><input id='valor"+cursor+r5.id_categoria+r7.id_item+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='input"+r5.id_categoria+r7.id_item+"' class='valor' size='4' /></td></tr>";										
											});	
											cont++;
											});										
										});			
									});	
									// Aqui se agrega la alternativa adicional "no existen ubiaciones adicionales"									
									alternativasDB().filter({'id_categoria':null},{'id_pregunta':id_pregunta}).each(function (r7) {												
										itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {  																				
											html=html+"<tr id='"+r8.id_item+"'><td item='"+r7.id_item+"' colspan='3' style='text-align:left'><input type='radio' id='radio"+cont+"' pregunta='"+cursor+"' categoria='null' item='"+r7.id_item+"' name='radio"+cursor+"null' value='null"+r8.id_item+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";										
										});	
									});	
									html=html+"</table>";                         
									}
									else
									{										
										// Si no existen categorias para esta pregunta, cargar directamente las alternativas
										html=html+"<div><table id='tabla_alternativas"+cursor+"' width='100%' border='1' align='left'></div>";
										var cont=1;
										alternativasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {					
												cont++;
												itemesDB().filter({'id_item':r5.id_item}).each(function (r6) {	
													if(r6.id_item=='34')	
														html=html+"<tr><td id='"+r6.id_item+"' colspan='2' style='text-align:left'><input type='radio' id='radio"+cont+"' pregunta='"+cursor+"' categoria='null' item='"+r5.id_item+"' name='radio"+cursor+"null' value='null"+r6.id_item+"' /><label style='font-size:0.9em'>"+r6.nombre_item+"</label></td></tr>";										
													else
														html=html+"<tr><td id='"+r6.id_item+"' style='text-align:left' width='50%'><label style='font-size:0.9em'>"+r6.nombre_item+"</label></td><td width='20%'><input id='valor"+cont+"' pregunta='"+cursor+"' categoria='"+r5.id_categoria+"' item='"+r5.id_item+"' name='input"+r5.id_categoria+r5.id_item+"' class='valor' size='4' /></td></tr>";										
												});															
										});		
										html=html+"</table>";									
									}															
									// $('#seccion'+r3.id_topico+r2.id_seccion).dataTable().fnAddData([html]);	
									$('#respuesta').html(html);									
									// Si existen respuestas buscar las respuestas correspondientes a la pregunta actual y cargarlas																		
									respuestasDB().filter({'id_pregunta':id_pregunta}).each(function (r10) {	
										if($.inArray(r10.id_item,["33","34","35"])==-1)
										{									
											$('[name=input'+r10.id_categoria+r10.id_item+']').val(r10.valor_respuesta);
										}
										else
										{
											$("[name='radio"+cursor+"null']").filter('[pregunta='+id_pregunta+'][categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').prop('checked', true);
											$("[name='radio"+cursor+"null']").filter('[pregunta='+id_pregunta+'][categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').parent().addClass(seleccionada);										
										}
									});																																																																                           																			
									break;		
							}
                            break;							
                        case 2:// Tipo numerico => cargar un input                                                        
                            var html="<div style='height:50px'><input id='valor"+id_pregunta+"' valor='null' categoria='null' size='4' item='null' /></div>";
                            // $('#respuesta').html(html);
							// $('#seccion'+r3.id_topico+r2.id_seccion).dataTable().fnAddData([html]);
							$('#respuesta').html(html);
							// Si existen respuestas buscar las respuestas correspondiente a la pregunta actual y cargarlas
							// alert('voy a cargar la respuesta');				
							respuestasDB().filter({'id_pregunta':cursor}).each(function (r10) {	
								// alert(r10.valor_respuesta);
								$('#valor'+id_pregunta).val(r10.valor_respuesta);								
							});							
                            // $('#valor').css('font-size','20px');					
                            break;				
                    }						
                });
            });
        });
	// $('#pregunta').addClass('ui-widget-content');		
	// $('#respuesta').addClass('ui-widget-content');		
	// $('#respuesta table tbody tr').addClass('ui-widget-header');
	return true;
    }
		
	// Carga listener para eventos para cada pregunta y sus validaciones
	
    function cargar_listener(id_pregunta)
    {					     			
        // Filtrar preguntas por id_pregunta segun cursor actual		
        preguntasDB().filter({'id_pregunta':id_pregunta}).each(function (r1) { 			
			
            seccionesDB().filter({'id_seccion':r1.id_seccion}).each(function (r2) { 

                topicosDB().filter({'id_topico':r2.id_topico}).each(function (r3) { 				          

                    switch(parseInt(r1.tipo))
                    {
                        case 1:// Tipo alternativa => cargar las alternativas para esta pregunta
                            // Verificar si existen categorias para esta pregunta	                                                       							
																					
							switch(parseInt(r1.tipo2))
							{								
								case 1: // Tipo disyuntiva										
									if(id_pregunta==19)
									{				
										var ok=true;
										respuestasDB().filter({'id_pregunta':17}).each(function(r1){
											if(respuestasDB().filter({'id_pregunta':18},{'id_categoria':r1.id_categoria},{'id_item':r1.id_item}).count()==0)
											{		
												if(!ok)
													return false;											
												alert("Por cada SKU marcado en la pregunta '1.4.4' debe haber un precio correspondiente. Revise porfavor");														
												cursor=cursor-2;
												cargar_contenido(cursor);
												cargar_listener(cursor);
												ok=false;
												return false;
											}
										});	
										if(ok)
											cuestionario_valido=true;
										else
											cuestionario_valido=false;
									}
									$('#tabla_alternativas'+cursor+' tr td:has(input)').mousedown(function(){
										if($.inArray(id_pregunta,[21,22,23,24,25,26,27,28,29,30])!=-1)
										{											
											// Si se selecciono "no hay ubicaciones adicionales", "No hay SKUs de Red Bull disponibles" deseleccionar el resto de alternativas
											if($.inArray($(this).children().attr('item'),['31','33','34','36'])!=-1)
											{
												$(':input').parent('.'+seleccionada).removeClass();
												$(':input').prop('checked',false);   
												// Eliminar todas las respuestas para esta pregunta
												respuestasDB({'id_pregunta':id_pregunta}).remove();	
											}
											else
											{
												$('[name=radio'+id_pregunta+'null]').parent('.'+seleccionada).removeClass();												                           
												$('[name=radio'+id_pregunta+'null]').prop('checked',false);                                
												// Eliminar todas las respuestas para esta pregunta
												respuestasDB({'id_pregunta':id_pregunta},{'id_item':'31'}).remove();
											}
										}
										$('[name=radio'+$(this).children().attr('pregunta')+$(this).children().attr('categoria')+']').parent('.'+seleccionada).removeClass();
										$(this).addClass(seleccionada);                                
										$('[name=radio'+$(this).children().attr('pregunta')+$(this).children().attr('categoria')+']').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', true);                                
										guardarRespuesta(id_pregunta,$(this).children().attr('categoria'),$(this).children().attr('item'),null);																																						
										
										// Verificar concistencia de respuestas para esta sección
										if((id_pregunta>21 && id_pregunta <26) || (id_pregunta>26 && id_pregunta <31) || (id_pregunta>34 && id_pregunta <38) || (id_pregunta>38 && id_pregunta <42))
										{
											var valido;
											respuestasDB().filter({'id_pregunta':id_pregunta}).each(function(r1){													
												valido=false
												respuestasDB().filter({'id_pregunta':id_pregunta-1},{'id_categoria':r1.id_categoria}).each(function(r3){													
													valido=true;
													return false;
												});												
											});
											if(!valido)
											{
												alert("En la pregunta anterior no están las mismas ubicaciones marcadas. Revise por favor");
												$(this).removeClass();
												$(this).children().prop('checked',false);
												respuestasDB({'id_pregunta':id_pregunta},{'id_categoria':$(this).children().attr('categoria')},{'id_item':$(this).children().attr('item')}).remove();												
												return false;
											}
										}																					
									});													
									break;
								case 2: // Tipo conjuntiva	
																							
									// Hacer matching entre itemes preguntas anteriores		
									if(id_pregunta==17)
									{
										var ok=true;
										// AL MENOS Por cada respuesta en pregunta 15 debe haber una respuesta en pregunta 16																								
										respuestasDB().filter({'id_pregunta':15}).each(function(r1){													
											if(respuestasDB().filter({'id_pregunta':16},{'id_categoria':r1.id_categoria},{'id_item':r1.id_item}).count()==0)
											{			
												if(!ok)
													return false;
												alert("Por cada SKU marcado en la pregunta '1.4.2' debe haber un precio correspondiente. Revise porfavor");
												cursor=cursor-2;
												cargar_contenido(cursor);
												cargar_listener(cursor);
												ok=false;
												return false;
											}
										});
										if(ok)										
											cuestionario_valido=true;
										else
											cuestionario_valido=false;
									}
									// Verificar que si se contesto facing distinto de nulo en pregunta 1, no se deje de marcar presencia en pregunta relacionada
									if(id_pregunta==15)
									{	
										
										if(respuestasDB().filter({'id_pregunta':1}).count()!=0 &&
										   parseInt(respuestasDB().filter({'id_pregunta':1}).select('valor_respuesta'))!=0 &&
										   respuestasDB().filter({'id_pregunta':14}).count()==0)										 
										{
											alert("En la pregunta '1.1.1' ha contestado un valor de 'facings' totales distinto de 0. No puede haber quiebre de latas si existen 'facings'. Porfavor revise");
											cursor=cursor-1;
											cargar_contenido(cursor);
											cargar_listener(cursor);
											return false;
										}																				
									}
									// Verificar que si se contesto facing distinto de nulo en pregunta 6, no se deje de marcar presencia en pregunta relacionada
									if(id_pregunta==18)
									{
										if(respuestasDB().filter({'id_pregunta':6}).count()!=0 &&
										   parseInt(respuestasDB().filter({'id_pregunta':6}).select('valor_respuesta'))!=0 &&
										   respuestasDB().filter({'id_pregunta':17}).count()==0)										 
										{
											alert("En la pregunta '1.1.3' ha contestado un valor de 'facings' totales distinto de 0. No puede haber quiebre de competencia si existen 'facings'. Porfavor revise");
											cursor=cursor-1;
											cargar_contenido(cursor);
											cargar_listener(cursor);
											return false;
										}
									}									
									$('#tabla_alternativas'+cursor+' tr td:has(input)').mousedown(function(){	
										if($.inArray($(this).children().attr('item'),['31','33','34','35'])!=-1)											
										{
											// Si se selecciono "no hay ubicaciones adicionales", "No hay SKUs de Red Bull disponibles" deseleccionar el resto de alternativas
											if($.inArray(id_pregunta,[14,15,17])!=-1)
											{
											
												$(':input').parent('.'+seleccionada).removeClass();
												$(':input').prop('checked',false);   
												// Eliminar todas las respuestas para esta pregunta
												respuestasDB({'id_pregunta':id_pregunta}).remove();
												$(this).addClass(seleccionada);                                
												$('[name=radio'+$(this).children().attr('pregunta')+$(this).children().attr('categoria')+']').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', true);                                																							
											}
										}
										else
										{																						
											if($(this).children().prop('checked'))
											{
												$(this).removeClass(seleccionada);
												$('[name=checkbox]').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', false);																															
												if($.inArray(id_pregunta,[15,17])!=-1)
												{																				
													// Si se deselecciono algun checkbox el precio no deberia existir
													if(respuestasDB().filter({'id_pregunta':id_pregunta+1},{'id_categoria':$(this).children().attr('categoria')},{'id_item':$(this).children().attr('item')}).count()!=0)
													{
														alert("El 'SKU' correspondiente tiene un precio en la siguiente regunta ('1.4.3'). Debe quitar el precio primero");													
														$(this).addClass(seleccionada);        											
														$('[name=checkbox]').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', true);
														return false;
													}													
												}
											}
											else
											{
												$('[name=radio'+id_pregunta+'null]').parent('.'+seleccionada).removeClass();												                           
												$('[name=radio'+id_pregunta+'null]').prop('checked',false);                                
												// Eliminar todas las respuestas para esta pregunta
												respuestasDB({'id_pregunta':id_pregunta},{'id_item':['33','34','35']}).remove();
												$(this).addClass(seleccionada);        											
												$('[name=checkbox]').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', true);
												// Verificar que el facing no sea 0 en pregunta 1											
												if(id_pregunta==14)
												{
													if(respuestasDB().filter({'id_pregunta':1}).count()==0)
													{
														alert("No ha contestado pregunta '1.1.1' correspondiente a 'facings' totales. No puede haber presencia si no hay 'facings'.");
														$(this).removeClass(seleccionada);
														$('[name=checkbox]').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', false);																															
														respuestasDB({'id_pregunta':id_pregunta},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).remove();
														id_respuesta--;
														return false;											
													}
													if(parseInt(respuestasDB().filter({'id_pregunta':1}).select('valor_respuesta'))==0)
													{
														alert("En la pregunta '1.1.1' ha contestado 0 'facings' totales. No puede haber presencia si no hay 'facings'.");
														$(this).removeClass(seleccionada);
														$('[name=checkbox]').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', false);																															
														respuestasDB({'id_pregunta':id_pregunta},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).remove();
														id_respuesta--;
														return false;											
													}
												}	
												// Verificar que el facing no sea 0 en pregunta 6
												if(id_pregunta==17)
												{
													if(respuestasDB().filter({'id_pregunta':6}).count()==0)
													{
														alert("No ha contestado pregunta '1.1.6' correspondiente a 'facings' totales. No puede haber presencia si no hay 'facings'.");
														$(this).removeClass(seleccionada);
														$('[name=checkbox]').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', false);																															
														respuestasDB({'id_pregunta':id_pregunta},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).remove();
														id_respuesta--;
														return false;											
													}											
													if(parseInt(respuestasDB().filter({'id_pregunta':6}).select('valor_respuesta'))==0)
													{
														alert("En la pregunta '1.1.3' ha contestado 0 'facings' totales. No puede haber presencia si no hay 'facings'.");
														$(this).removeClass(seleccionada);
														$('[name=checkbox]').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', false);																															
														respuestasDB({'id_pregunta':id_pregunta},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).remove();
														id_respuesta--;
														return false;											
													}
												}																									
											}					
										}
										guardarRespuesta(id_pregunta,$(this).children().attr('categoria'),$(this).children().attr('item'),null);  																											
									});																													
									break;																					                                                     
								case 3: // Tipo conjuntiva con valor
									var pregunta=$('.valor:first').attr('pregunta');								
									var categoria=$('.valor:first').attr('categoria');
									var item=$('.valor:first').attr('item');																		
									
									$('[categoria='+categoria+'][item='+item+']').focus();
									
									$('.valor').focusin(function(){
										pregunta=$(this).attr('pregunta');
										categoria=$(this).attr('categoria');
										item=$(this).attr('item');
									});	
									// Hacer matching entre presencias y quiebres preguntas anteriores (deben ser complementarios)	
									if(id_pregunta==16)
									{										
										var ok=true;
										// Por cada respuesta en pregunta 14 debe haber una omision en pregunta 15, si es que la respuesta no fue "no hay SKUs de RedBull disponibles"																								
										respuestasDB().filter({'id_pregunta':14}).each(function(r1){		
											if(r1.id_item!=33)
											{
												if(respuestasDB().filter({'id_pregunta':15},{'id_categoria':r1.id_categoria},{'id_item':r1.id_item}).count()>0)										
												{																								
													if(!ok)
														return false;
													alert("Existen SKUs marcados como presentes en '1.4.1' y marcados como ausentes en pregunta '1.4.2'. Revise porfavor");
													cursor=cursor-2;
													cargar_contenido(cursor);
													cargar_listener(cursor);
													ok=false;
													return false;
												}
											}
											// else
											// {	// Si se selcciono "no hay SKUs de RedBull disponibles, debe haber consistencia en las preguntas siguientes
												// if(respuestasDB().filter({'id_pregunta':15},{'id_item'33}).count()==0)
												// {
													// if(!ok)
														// return false;
													// alert("Se marcó 'No hay SKUs de Red Bull disponibles en '1.4.1', sin embargo se marcó  '1.4.2'. Revise porfavor");
													// cursor=cursor-2;
													// cargar_contenido(cursor);
													// cargar_listener(cursor);
													// ok=false;
													// return false;												
												// }
											// }
										});
										if(ok)										
											cuestionario_valido=true;
										else
											cuestionario_valido=false;
									}		
									$('#tabla_alternativas'+cursor+' tr td:has(:radio)').mousedown(function(){
										// Verificar que sea concistente con pregunta anterior										
										if(respuestasDB({'id_pregunta':id_pregunta-1},{'id_item':["35","34"]}).count()==0)
										{
											alert("En pregunta anterior se marcó SKUs con etiqueta de precio. Por favor revise");																								
											respuestasDB({'id_pregunta':id_pregunta},{'id_item':["35","34"]}).remove();
											return false;
										}		
										// Si se selecciono "No hay etiqueta"
										$('.valor').val('');				
										// Eliminar respuestas para esta pregunta, si existen
										respuestasDB({'id_pregunta':id_pregunta}).remove();
										id_respuesta--;										
										$(this).addClass(seleccionada);   										
										$('[name=radio'+$(this).children().attr('pregunta')+$(this).children().attr('categoria')+']').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', true);                                
										guardarRespuesta(id_pregunta,$(this).children().attr('categoria'),$(this).children().attr('item'),null);
										// Eliminar los precios ingresados, si existen
									});
									$('.valor').keyup(function(event){																						
										if(parseInt($(this).val()).toString()!="NaN")
										{								
											// Verificar que sea concistente con pregunta anterior
											if(respuestasDB({'id_pregunta':id_pregunta-1},{'id_item':["35","34"]}).count()>0)
											{
												alert("En pregunta anterior se marcó 'No hay etiqueta de precio para SKUs'. Por favor revise");													
												$(this).val('');
												respuestasDB({'id_pregunta':id_pregunta},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).remove();
												return false;
											}	
											// Si se ingresó un precio válido, remover respuesta "No hay etiqueta de precio para SKUs de Red Bull"
											$(':input').parent('.'+seleccionada).removeClass();
											$(':input').prop('checked',false);   
											// Eliminar respuesta "No hay etiqueta", si existe
											respuestasDB({'id_pregunta':id_pregunta},{'id_item':'35'}).remove();											
											$('[name=radio'+$(this).children().attr('pregunta')+$(this).children().attr('categoria')+']').filter('[pregunta='+$(this).children().attr('pregunta')+'][categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', true);                                										
											// Guardar la respuesta
											$(this).val(parseInt($(this).val()));
											$(this).attr('valor',$(this).val());
											guardarRespuesta(id_pregunta,$(this).attr('categoria'),$(this).attr('item'),$(this).val());	
											
											// Validacion de precios segun SKUs con flejes (grupo1)
												
											if($.inArray(id_pregunta,[16,18])!=-1)
											{																												
												// Si se ingreso algun precio, el SKU debe estar previamente marcado
												if(respuestasDB({'id_pregunta':[id_pregunta-1,id_pregunta-2]},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).count()==0)
												{
													alert("El 'SKU' correspondiente no está marcado en la pregunta anterior ('1.4.2'). Debe quitar el precio o marcar el SKU");
													$(this).val('');
													// Eliminar la respuesta
													respuestasDB({'id_pregunta':id_pregunta},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).remove();
													id_respuesta--;
													return false;
												}													
											}											
										}
										else
										{																								
											$(this).val('');											
											if($.inArray(id_pregunta,[16,18])!=-1)
											{										
												// Si se quito un precio el SKU debe estar desmarcado
												if($(this).val()=='')
												{
													if(respuestasDB().filter({'id_pregunta':id_pregunta-1},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).count()>0)
													{
														alert("El 'SKU' correspondiente está marcado en la pregunta anterior ('1.4.2'). Debe ingresar un precio o desmarcar el SKU");
														$(this).val('');
														// Eliminar la respuesta
														respuestasDB({'id_pregunta':id_pregunta},{'id_categoria':$(this).attr('categoria')},{'id_item':$(this).attr('item')}).remove();
														id_respuesta--;
														return false;
													}												
												}
											}
										}
									});
									break;		
							}
                            break;							
                        case 2:// Tipo numerico => cargar un input     																		
							setTimeout("setFocus('valor"+id_pregunta+"')", 0);
							
							$('#valor'+id_pregunta).keyup(function(event){															
								
								if(parseInt($(this).val()).toString()!="NaN")
								{
									// Guardar la respuesta
									$(this).val(parseInt($(this).val()));
									$(this).attr('valor',$(this).val());
									guardarRespuesta(id_pregunta,$(this).attr('categoria'),$(this).attr('item'),$(this).val());									
									// Si esta en pregunta 33 las preguntas siguientes son dependientes de lo que se ingrese aqui									
									// Validacion totales primer grupo									
									if($.inArray(id_pregunta,[1,2,3,4,5,6])!=-1)
									{										
										var valores= new Array();
										respuestasDB().filter({id_pregunta:[1,2,3,4,5,6]}).each(function(r1){
											valores.push(parseInt(r1.valor_respuesta));											
										});											
										var parciales=0;
										for(var i=1;i<valores.length;++i)
											parciales+=valores[i];										
										if(valores[0]<parciales)
										{
											alert("El 'facing' total en la pregunta 1.1.1 no puede ser inferior a la suma de 'facings' parciales. Por favor verifique");
											$(this).val('');
											// Eliminar la respuesta
											respuestasDB({'id_pregunta':id_pregunta}).remove();	
											id_respuesta--;																								
										}
										else
										{												
											return true;
										}
									}
									// Validacion totales segundo grupo
									if($.inArray(id_pregunta,[10,11,12,13])!=-1)
									{
										var valores= new Array();
										respuestasDB().filter({id_pregunta:[10,11,12,13]}).each(function(r1){
											valores.push(parseInt(r1.valor_respuesta));											
										});										
										var parciales=0;
										for(var i=1;i<valores.length;++i)
											parciales+=valores[i];											
										if(valores[0]<parciales)
										{
											alert("El 'facing' total en la pregunta '1.3.1' no puede ser inferior a la suma de 'facings' parciales. Por favor verifique");
											$(this).val('');
											// Eliminar la respuesta
											respuestasDB({'id_pregunta':id_pregunta}).remove();
											id_respuesta--;
										}
										else
										{												
											return true;
										}																											
									}												
								}
								else
								{
									$(this).val('');
								}															
							});							
                        break;				
                    }						
                });
            });
        });		
		return true;
    }		
	
	function activarCajas(cajas)
	{				
		var cont=6; // 1a Caja
		var activas=cont+cajas; // Cajas activas
		var valores1= new Array();
		var valores2= new Array();
		
		while(cont<activas)
		{
			valores1.push(cont);
			cont++;
		}
		while(cont<15)
		{
			valores2.push(cont);
			cont++;
		}		
		// Se activan las categorias menores o iguales a la cantidad ingresada
		categoriasDB().filter({id_categoria:valores1}).update({estado_categoria:true});
		// Se desactivan las categorias menores o iguales a la cantidad ingresada
		categoriasDB().filter({id_categoria:valores2}).update({estado_categoria:false});												
	}
	
	function setFocus(id)
	{
		document.getElementById(id).focus();
	}	
			
    function guardarRespuesta(id_pregunta,id_categoria,id_item,valor)    
    {		
        var existeRespuesta=false;
        var tipoPregunta;		       
		
		preguntasDB().filter({'id_pregunta':id_pregunta}).each(function (r0) {
            tipoPregunta=r0.tipo2;
            return false;
        });		
		
		switch(parseInt(tipoPregunta))
		{
			case 1: // TIPO DISYUNTIVA -> Buscar si existe la misma: pregunta y categoria	

				respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':id_categoria}).each(function () {
					existeRespuesta=true;
					return false;
				});							
				if(existeRespuesta)// Si existe la respuesta, actualizarla
				{
					respuestasDB({'id_pregunta':id_pregunta,'id_categoria':id_categoria}).update({valor_respuesta:valor,id_item:id_item,id_categoria:id_categoria});					
				}
				else // Sino existe la respuesta, agregarla		
				{
					respuestasDB.insert(new respuesta(id_respuesta,valor,id_item,id_pregunta,id_categoria));              
					id_respuesta++;
				}
				break;
			case 2: // TIPO CONJUNTIVA => Buscar si existe la misma: pregunta, categoria e item
				respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':id_categoria,'id_item':id_item}).each(function () {
					existeRespuesta=true;
					return false;
				});						
				if(existeRespuesta)  // Si existe la respuesta, eliminarla
				{ 					
					respuestasDB({'id_pregunta':id_pregunta,'id_categoria':id_categoria,'id_item':id_item}).remove();
					id_respuesta--;
				}
				else // Sino existe la respuesta, agregarla
				{
					respuestasDB.insert(new respuesta(id_respuesta,valor,id_item,id_pregunta,id_categoria));              
					id_respuesta++;
				}				
				break;		
			case 3:
				respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':id_categoria,'id_item':id_item}).each(function () {
					existeRespuesta=true;
					return false;
				});
				if(existeRespuesta)// Si existe la respuesta, actualizarla
				{
					respuestasDB({'id_pregunta':id_pregunta,'id_categoria':id_categoria,'id_item':id_item}).update({valor_respuesta:valor,id_item:id_item,id_categoria:id_categoria});
				}
				else // Sino existe la respuesta, agregarla		
				{
					respuestasDB.insert(new respuesta(id_respuesta,valor,id_item,id_pregunta,id_categoria));              
					id_respuesta++;
				}				
				break;
				
		}        				
        // respuestasDB().each(function (r1) {
           // console.log(r1); 
        // });
    }				

	function save_content_to_file(content, filename){		
		var dlg = false;
		with(document){
		 ir=createElement('iframe');
		 ir.id='ifr';
		 ir.location='about.blank';
		 ir.style.display='none';
		 body.appendChild(ir);
		
		  with(getElementById('ifr').contentWindow.document){
			   open("text/plain", "replace");
			   charset = "utf-8";
			   write(content);
			   close();
			   document.charset = "utf-8";
			   dlg = execCommand('SaveAs', true, filename);
		   }
		   //body.removeChild(ir);
		 }
		return dlg;
	}	
	
	function validar_cuestionario(){

		var adicionales=parseInt($('#select_cajas').val());
		
		var preguntas_requeridas;						
		
		if(adicionales>0)
			preguntas_requeridas=42;
		else
			preguntas_requeridas=33;
		
		if(respuestasDB().distinct('id_pregunta').length==preguntas_requeridas)
		{
			return true;
		}
		else
		{
			return false;
		}
	}
	
	function validar_pregunta(id_pregunta){			
		
		var ok=true;	
		var flag=false;
		
		if(flag)
			return false;			
	
		var tieneCategoria=(preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).count()>0);			
		var tipo1=parseInt(preguntasDB().filter({'id_pregunta':id_pregunta}).select('tipo'));
		var tipo2=parseInt(preguntasDB().filter({'id_pregunta':id_pregunta}).select('tipo2'));			
		var aux=false;																					
		
		switch(tipo1)
		{
			case 1: //Tipo alternativa
			
				switch(tipo2)
				{
					case 1: // Tipo disyuntiva		
						if(tieneCategoria)
						{					
							if((id_pregunta>21 && id_pregunta <26) || (id_pregunta>26 && id_pregunta <31) || (id_pregunta>34 && id_pregunta <38) || (id_pregunta>38 && id_pregunta <42))						
							{
								if(respuestasDB({'id_pregunta':id_pregunta-1}).count()!=respuestasDB({'id_pregunta':id_pregunta}).count())
									ok=false;
							}
							// Ahora ademas hay que considerar que en estos casos puede haber respuesta sin categoria
							if(respuestasDB().filter({'id_pregunta':id_pregunta},{'id_item':['31','36']}).count()>0)
							{
								aux=true;
							}
							else
							{									
								if(id_pregunta>33)
								{
									respuestasDB().filter({'id_pregunta':33}).each(function(r20){												
										maxCat=parseInt(r20.valor_respuesta);												
									});
								}
								else
								{
									maxCat=15;
								}
								
								var contCat=0;
										
								var flag2=false;
							
								var cont1=1;								
								preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function(categoria){		
									if(flag2)
										return false;								
										
									var cont2=0;
									respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':(categoria.id_categoria).toString()}).each(function(){
										aux=true;
										return false;
										cont2++;
									});
									cont1=cont1*cont2;
									
									contCat++;
											
									if(contCat>=maxCat)																						
										flag2=true;									
								});
								if(cont1!=0) // Para cada categoria debe haber una respuesta
									aux=true; 
							}
						}
						else
						{								
							respuestasDB().filter({'id_pregunta':id_pregunta}).each(function(respuesta){
								aux=true;	
								return false;
							});
						}							
						break;
					case 2: // Tipo conjuntiva
						if(tieneCategoria)
						{
							// Ahora ademas hay que considerar que en estos casos puede haber respuesta sin categoria
							if(respuestasDB().filter({'id_pregunta':id_pregunta},{'id_item':['33','34','35','37']}).count()>0)
							{
								aux=true;
							}
							var cont=0;
							preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function(categoria){	
								// alert('soy categoria conjuuntiva');
								// alert(JSON.stringify(categoria)); 
								// alert(respuestasDB().filter({'id_pregunta':pregunta.id_pregunta}).stringify());
								respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':(categoria.id_categoria).toString()}).each(function(){									
									cont++;
									return false;
								});
							});
							if(cont>0) // Para al menos una categoria debe haber una respuesta
								aux=true; 								
						}
						else
						{
							respuestasDB().filter({'id_pregunta':id_pregunta}).each(function(respuesta){
								aux=true;	
								return false;
							});
						}
						break;
					case 3: // Tipo conjuntiva con valor
						if(tieneCategoria)
						{
							// Ahora ademas hay que considerar que en estos casos puede haber respuesta sin categoria
							if(respuestasDB().filter({'id_pregunta':id_pregunta},{'id_item':['33','34','35']}).count()>0)
							{
								aux=true;
							}						
							var cont=0;
							preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function(categoria){									
								respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':(categoria.id_categoria).toString()}).each(function(){
									cont++;
									return false;
								});
							});
							if(cont>0) // Para al menos una categoria debe haber una respuesta
								aux=true;
						}
						else
						{
							respuestasDB().filter({'id_pregunta':id_pregunta}).each(function(respuesta){
								if(respuesta.valor_respuesta!=null || respuesta.id_item!=null)						
									aux=true;						
							});
						}							
				}
				break;
			case 2: //Tipo valor					
				respuestasDB().filter({'id_pregunta':id_pregunta}).each(function(respuesta){
					if(respuesta.valor_respuesta!=null)						
						aux=true;						
				});
				break;
		}
		ok=ok*aux;
		
		if(!ok)
		{								
			alert("Esta pregunta no ha sido correctamente respondida. Porfavor verifique");				
			flag=true;
			return false;
		}
	
		if(ok)
		{		
			// if(confirm("Cuestionario completado correctamente, ¿Confirma el envío de la toma?"))
				// enviar_toma2();
			contestadas++;
			return true;
		}		
		else
		{
			// alert('ups...algo raro paso');
		}
	}
	
	function enviar_toma2(){			
		$('#container').hide();		
		
		var xmlhttp;				
		
		// Para enviar la toma mediante GET el stream total se debe dividir en 3 segmentos (limite largo URL) (Maximo respuestas 155)
		
		// Primero Calculamos cantidad de respuestas
		
		var largo_respuestas=respuestasDB().get().length;		
		
		// alert('largo_respuestas='+largo_respuestas);
		
		// Luego obtenemos desplazamientos en base al largo de las respuestas
		
		var offset1=largo_respuestas/3;
		var offset2=2*largo_respuestas/3;

		// alert("offset1="+offset1);
		// alert("offset2="+offset2);
		
		// Creamos los tres segmentos
		
		var id_medicion= $('#mediciones').val();
		
		var obj_toma1=new toma(id_medicion,new Date(),2,codigo_auditor,folio_sala,respuestasDB().limit(offset1).select('id_pregunta','id_categoria','id_item','valor_respuesta'));		
		var obj_toma2=new toma(id_medicion,new Date(),2,codigo_auditor,folio_sala,respuestasDB().start(offset1+1).limit(offset1).select('id_pregunta','id_categoria','id_item','valor_respuesta'));				
		var obj_toma3=new toma(id_medicion,new Date(),2,codigo_auditor,folio_sala,respuestasDB().start(offset2+1).select('id_pregunta','id_categoria','id_item','valor_respuesta'));						
		
		// alert(JSON.stringify(obj_toma1));
		// alert(JSON.stringify(obj_toma2));
		// alert(JSON.stringify(obj_toma3));
		// return false;
		// Luego se debe hacer 3 GETS para enviar cada segmento de la toma
		
		if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari			
			xmlhttp=new XMLHttpRequest();
		}
		else{// code for IE6, IE5
			xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		}		
		xmlhttp.onreadystatechange=function(){
		
			if (xmlhttp.readyState==4 && xmlhttp.status==200){
				
				var data = JSON.parse(xmlhttp.responseText);
				
				// Recuperamos el id de la toma que se ingreso en el GET
				var id_toma= data.id_toma;
				
				switch(parseInt(data.Codigo))
				{
					case 0: // Si hubo errores no manejables en la transaccion
						$('#container').show();				
						$('#dialog_enviando_toma').hide();									
						alert("Error al ingresar el 1er segmento de la toma. porfavor vuelva a intentarlo más tarde.\nDetalles: "+data.Mensaje);
						break;
					case 2: // Si la toma enviada ya existe							
						alert(data.Mensaje);						
						break;
					case 1: // Si el primer envio fue exitoso continuar con el segundo envio					
						// Si el segundo segmento esta vacio terminar el proceso
						
						if($.isEmptyObject(obj_toma2.respuestas))
						{
							alert("Envio completado con exito. Por favor confirme el siguiente diálogo para actualizar el estado de la toma");
							obj_toma= new toma(id_medicion,new Date(),3,codigo_auditor,folio_sala,respuestasDB().get());		
							save_content_to_file(JSON.stringify(obj_toma), pathCuestionario);
							$('#container').hide();
							$('#dialog_enviando_toma').hide();
							$('#fin').show();
							// $('#volver').show();
							// location.reload(true);																															
							return true;
						}
						
						// alert(xmlhttp.responseText);
						var xmlhttp2;
						
						if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari			
							xmlhttp2=new XMLHttpRequest();
						}
						else{// code for IE6, IE5
							xmlhttp2=new ActiveXObject("Microsoft.XMLHTTP");
						}		
						xmlhttp2.onreadystatechange=function(){
						
							if (xmlhttp2.readyState==4 && xmlhttp2.status==200){
								
								// alert(xmlhttp2.responseText);
								var data2 = JSON.parse(xmlhttp2.responseText);
								
								switch(parseInt(data2.Codigo))
								{
									case 0:
										$('#container').show();
										alert("Error al ingresar el 2o segmento de la toma, porfavor vuelva a intentarlo más tarde.\nDetalles: "+data.Mensaje);
										break;
									case 1: // Si el segundo envio fue exitoso continuar con el tercer envio
									
										// Si el tercer segmento esta vacio terminar el proceso
						
										if($.isEmptyObject(obj_toma3.respuestas))
										{
											alert("Envio completado con exito. Por favor confirme el siguiente diálogo para actualizar el estado de la toma");
											obj_toma= new toma(id_medicion,new Date(),3,codigo_auditor,folio_sala,respuestasDB().get());		
											save_content_to_file(JSON.stringify(obj_toma), pathCuestionario);
											$('#container').hide();
											$('#dialog_enviando_toma').hide();
											$('#fin').show();											
											// $('#volver').show();
											// location.reload(true);																																				
											return true;
										}
										
										var xmlhttp3;
										
										if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari			
											xmlhttp3=new XMLHttpRequest();
										}
										else{// code for IE6, IE5
											xmlhttp3=new ActiveXObject("Microsoft.XMLHTTP");
										}		
										xmlhttp3.onreadystatechange=function(){
										
											if (xmlhttp3.readyState==4 && xmlhttp3.status==200){
												
												// alert(xmlhttp3.responseText);
												var data3 = JSON.parse(xmlhttp3.responseText);
												
												switch(parseInt(data3.Codigo))
												{
													case 0:
														$('#container').show();
														alert("Error al ingresar el 3er segmento de la toma, porfavor vuelva a intentarlo más tarde. \nDetalles: "+data.Mensaje);
														break;
													case 1: // Si el tercer envio fue exitoso actualizar el estado de la toma local	
														alert("Envio completado con exito. Por favor confirme el siguiente diálogo para actualizar el estado de la toma");
														obj_toma= new toma(id_medicion,new Date(),3,codigo_auditor,folio_sala,respuestasDB().get());		
														save_content_to_file(JSON.stringify(obj_toma), pathCuestionario);
														$('#container').hide();
														$('#dialog_enviando_toma').hide();
														$('#fin').show();
														// $('#volver').show();
														// location.reload(true);																												
														return true;													
														break;
												}
											}	
										}		
										// alert(JSON.stringify(obj_toma3));
										xmlhttp3.open("GET","http://200.29.139.244/REDBULL/php/cargar_maestra2.php?caso=3&id_toma="+id_toma+"&toma="+JSON.stringify(obj_toma3),true);
										xmlhttp3.send();																			
										break;
								}
							}	
						}
						// alert(id_toma);
						// alert(JSON.stringify(obj_toma2));
						xmlhttp2.open("GET","http://200.29.139.244/REDBULL/php/cargar_maestra2.php?caso=2&id_toma="+id_toma+"&toma="+JSON.stringify(obj_toma2),true);
						xmlhttp2.send();			
						break;
				}
			}	
		}		
		xmlhttp.open("GET","http://200.29.139.244/REDBULL/php/cargar_maestra2.php?caso=1&toma="+JSON.stringify(obj_toma1),true);
		xmlhttp.send();	
		setTimeout(function() { 
			if(xmlhttp.readyState!=4)
			{
				xmlhttp.abort(); 
				alert("Excede tiempo de respuesta, verifique que la conexión 3g esté activada. Si la conexión está activada intente con una mejor señal"); 
				return false;
			}
			else
				return true;				
		},60000);
	}		
	
$(document).ready(function() {			
	
	$( "#botones" ).buttonset();					
	// $( "#volver" ).buttonset();		
	
	$(document).keydown(function(e){		
			
		switch(e.keyCode)
		{					
			case 32:	
				e.preventDefault();			
				if(cursor==0)
				{
					$('#auditor').trigger('mousedown');										
					$('#codigo_auditor').val('');						
					return false;
				}				
				if(!validar_pregunta(cursor))
					return false;
				
				// $('input').addClass('ui-state-active');
				$("label[for='sig']").addClass('ui-state-active');
				var id='sig';
				
				if(cursor==33 && $('#dialog_encuesta_terminada').is(':visible'))				
					return false;				
					
				if(cursor==33 && $('#dialog_cajas').is(':visible'))
				{
					if(parseInt($('#select_cajas').val())==0)
					{						
						$('label.ui-state-active').removeClass('ui-state-active');
						$('#dialog_encuesta_terminada').show();
						$('#dialog_cajas').hide();
						$('#container').hide();
						$('#botones').show();
						return false;
					}
					activarCajas(parseInt($('#select_cajas').val()));
					cursor++;
					cargar_contenido(cursor);
					cargar_listener(cursor);
					$('#container').show();
					$('#dialog_cajas').hide();					
					$('#botones').show();
					return false;
				}
				if(cursor==33){																
					$('#container').hide();
					$('#dialog_cajas').show();	
					// $('#volver').hide();	
					$('#botones').hide();
					$('#boton_cajas').click(function(){						
						if(parseInt($('#select_cajas').val())==0)						
						{							
							$('label.ui-state-active').removeClass('ui-state-active');
							$('#dialog_encuesta_terminada').show();
							$('#dialog_cajas').hide();
							$('#container').hide();
							$('#botones').show();
							return false;
						}
						activarCajas(parseInt($('#select_cajas').val()));
						cursor++;
						cargar_contenido(cursor);
						cargar_listener(cursor);
						$('#container').show();
						$('#dialog_cajas').hide();					
						$('#botones').show();
					});	
					return false;
				}			
				if(cursor==42)
				{					
					$('label.ui-state-active').removeClass('ui-state-active');
					$('#dialog_encuesta_terminada').show();
					$('#dialog_cajas').hide();
					$('#container').hide();
					$('#botones').show();
					return false;
				}
				if(cursor<42)
					cursor++;				
				var dfd = $.Deferred();		 
				/* add handlers to be called when dfd is resolved */
				dfd
				/* .done() can take any number of functions or arrays of functions */
				.done( cargar_contenido(cursor),cargar_listener(cursor) )
				/* we can chain done methods, too */
				.done(function() {
				  // alert('estamos listos');
				  setTimeout(function() { $('label.ui-state-active').removeClass('ui-state-active'); }, 1000);
				  //$(event.target).removeClass('ui-state-active');				  
				});	
				dfd.resolve("and");			
				return false;
				break;
			// case 9:	
				// $('#ant').addClass('ui-state-active');
				// var id='ant';
				// cursor--;
				// break;
		}					
	});

	// $('button').button();
	// $('button').css('padding','0em');
	// $('span').css('padding','0em');	
	cargar_mediciones();
	
	// $('#volver').click(function(event){															
		// $('#sesion').show();
		// $('#botones').hide();
		// $('#container').hide();
		// $('#volver').hide();
		// $('label.ui-state-active').removeClass('ui-state-active');		
	// });
	
	$('.cursor').click(function(event){																			
		
		switch($(event.target).attr('id'))
		{
			case 'ant':
				if(cursor>1)							
					cursor--;
				break;
			case 'sig':
				if(!validar_pregunta(cursor))
				{
					$('label.ui-state-active').removeClass('ui-state-active');
					return false;				
				}
				if(cursor==33 && $('#dialog_encuesta_terminada').is(':visible'))				
					return false;				
				if(cursor==33){
					$('#container').hide();
					$('#dialog_cajas').show();
					// $('#volver').hide();
					$('#botones').hide();
					$('#boton_cajas').click(function(){
						activarCajas(parseInt($('#select_cajas').val()));
						$('#container').show();
						$('#dialog_cajas').hide();
						cursor++;
						cargar_contenido(cursor);
						cargar_listener(cursor);
						$('#botones').show();	
					});	
					return false;
				}		
				if(cursor==42)
				{				
					$('label.ui-state-active').removeClass('ui-state-active');
					$('#dialog_encuesta_terminada').show();
					$('#dialog_cajas').hide();
					$('#container').hide();
					$('#botones').show();
					return false;
				}
				if(cursor<42)							
					cursor++;			
				break;
			case 'guardar':
				var obj_toma=new toma(id_medicion,new Date(),1,codigo_auditor,folio_sala,respuestasDB().get());					
				save_content_to_file(JSON.stringify(obj_toma), pathCuestionario);
				break;
			case 'enviar':
				if(validar_cuestionario())
				{
					alert("Cuestionario completado. Por favor confirme el siguiente diálogo para guardar su trabajo y evitar posibles pérdidas");
					obj_toma= new toma(id_medicion,new Date(),2,codigo_auditor,folio_sala,respuestasDB().get());		
					save_content_to_file(JSON.stringify(obj_toma), pathCuestionario);			
					$('#dialog_encuesta_terminada').hide();
					$('#botones').hide();
					$('#dialog_enviando_toma').show();
					enviar_toma2();
					return false;					
				}
				else
				{
					alert("Existen preguntas que no han sido correctamente respondidas. Porfavor verifique");
				}
				break;			
		}											
		var dfd = $.Deferred();
		 
		/* add handlers to be called when dfd is resolved */
		dfd
		/* .done() can take any number of functions or arrays of functions */
		.done( cargar_contenido(cursor),cargar_listener(cursor) )
		/* we can chain done methods, too */
		.done(function() {
		  // alert('estamos listos');
		  setTimeout(function() { $('label.ui-state-active').removeClass('ui-state-active'); }, 1000);
		  //$(event.target).removeClass('ui-state-active');
		});				
		dfd.resolve("and");		
	});		
});

function listenerFiltro()
{	
	var filtrado= false;
	var indice=0;
	var clase='';

	$('#buscar').keydown(function(e){				
		setTimeout("setFocus('buscar')", 0);			
		switch(e.keyCode)
		{			
			case 13:					
				var needle=$('#buscar').val().toUpperCase();	
				var delta=$('#salas tbody tr:first').height();				
				// delta=0.97*delta;
				var offset=delta;
				var oSettings = $('#tabla_salas').dataTable().fnSettings();				
				
				if(needle=='')
				{
					$('.matched').removeClass('matched');	
					$('.matched_active').removeClass('matched_active');	
					return false;
				}
				if(!filtrado)
				{
					filtrado=true;							
					var hit=false;
					// $('.ui-state-active').removeClass('ui-state-active');				
					$('.matched').removeClass('matched');	
					$('.matched_active').removeClass('matched_active');	
					$('#tabla_salas tbody tr').each(function(){						
						var haystack=$(this).text().toString().toUpperCase();		
						// alert(haystack);
						if (haystack.indexOf(needle)!=-1) {															
							if(!hit)							
								clase='matched_active';														
							else							
								clase='matched';
														
							
							// $(this).addClass(clase);
							
							$('#tabla_salas tbody').children(':eq('+$(this).index()+')').addClass(clase);
							hit=true;							
						}
					});
					if(hit)
					{															
						offset=($('.matched_active:first').index())*delta;
						$('.dataTables_scrollBody').animate({ scrollTop: offset });		
					}
					else
					{
						alert('El item no fue encontrado');
						$('#buscar').val('');
						$('.dataTables_scrollBody').animate({ scrollTop: 0 });	
					}
				}
				else
				{									
					offset=($('.matched:first').index())*delta;
					if($('.matched').length<=1)
						filtrado=false;
					$('.matched_active').removeClass('matched_active');	
					$('#tabla_salas tbody tr.matched:first').addClass('matched_active');
					$('#tabla_salas tbody tr.matched:first').removeClass('matched');	
					
					// $('#tabla_salas tbody tr.matched:first').addClass('matched_active');
					// $('#tabla_salas tbody tr.matched:first').removeClass('matched');						
					
					$('.dataTables_scrollBody').animate({ scrollTop: offset });						
				}
				break;
			default:
				filtrado=false;
				break;
		}		
	});
}
</script>
</head>
<body>

<div id="container" style="width:100%;display:none;">
    <table id='cuestionario' width='100%' class='display table' border=1>
		<thead>
		<tr style="background-color:#000000">
			<th style='vertical-align:middle'>
				<h5 id='titulo' style="color:#FFFFFF;">
					CUESTIONARIO PSA
				</h5>
			</th>
		</tr>
		<thead>
		<tbody>
		<tr>
			<td id='topico' style='vertical-align:middle'>
					<h4 style="background-color:#000000;">
						Cargando...
					</h4>			
			</td>
		</tr>		
		<tr>
			<td id='seccion' style='vertical-align:middle'>
					<h4>
						Cargando...
					</h4>			
			</td>
		</tr>		
		<tr>
			<td id='pregunta' style='height:100px;' style='vertical-align:middle'>
				<h4>
					Cargando...
				</h4>
			</td>
		</tr>				
		<tr>
			<td id='respuesta' style='vertical-align:top'>				
				<h4>
					Cargando...
				</h4>
			</td>		
		</tr>	
		<tbody>
    </table>	    
</div>	
</body>
<div id="dialog_encuesta_terminada" align='center' style='display:none'>
	<p>
		Cuestionario completado correctamente. 
	</p>
	<p>
		Presione el botón "Enviar" para enviar la toma a la Base de Datos, o bien presione el botón de disco para guardarla localmente.
	</p>
</div>
<div id="dialog_enviando_toma" align='center' style='display:none'>
	<p>
		Enviando toma...
	</p>
	<p>
		Por favor espere. El envío puede llegar a tardar varios segundos, dependiendo de la intensidad de la señal.
	</p>
</div>
<div id='botones' style='display:none;text-align:center'>
	<input type="radio" class='cursor' id="ant" name="radio" /><label for="ant">Anterior</label>
	<input type="radio" class='cursor' id="guardar" name="radio" /><label for="guardar">Guardar</label>
	<input type="radio" class='cursor' id="enviar" name="radio" /><label for="enviar">Enviar</label>
	<input type="radio" class='cursor' id="sig" name="radio" /><label for="sig">Siguiente</label>	
</div>		
<!-- <div id='volver' style='display:none;text-align:center'>
	<input type="radio" class='cursor' id="volver" name="radio" /><label for="volver">Volver</label>
</div> -->		
<div id="sesion" style="width:100%;display:none">
	<table width='100%'>
			<thead>
			<table width='100%'>
				<thead>
					<tr>
						<th class='ui-widget-header' width='40%'>							
							MEDICION							
						</th>
						<th style='vertical-align:middle' width='60%'>							
							<select id='mediciones' style='width:100%;text-align:center;font-size:1em' disabled>	
								<option>
									CARGANDO...
								</option>
							</select>												
						</th>
					</tr>
				</thead>
			</table>
			<thead>
		<tr>
			<td>
				<div id='auditores'>
					<table width='100%'>
						<tr>
							<td class='ui-widget-header' width='40%'>
								ID AUDITOR
							</td>
							<td class='ui-widget-content' width='60%'>
								<input id='codigo_auditor' size=4 style='font-size:1.2em' />
								<button id='auditor' style='font-size:1em' class='btn'>
									OK
								</button>
							</td>
						</tr>
						<tr>
							<td class='ui-widget-header'>
								USUARIO
							</td>
							<td class='ui-widget-content' id='nombre_auditor' style='font-size:1.2em'>
								---
							</td>
						</tr>										
					</table>
				</div>
			</td>
		</tr>
		<tr>
			<td>
				<div id='salas'>
				</div>
			</td>
		</tr>
	</table>
</div>
<div id="dialog_cajas" align='center' style='display:none'>
	<p>
		¿Cuántas cajas registradoras tienen ubicaciones adicionales? Si no sabe, acepte la cantidad por defecto
	</p>
	<select id='select_cajas' style='font-size:1em'>
		<option value='0'>
			Ninguna
		</option>
		<option value='1'>
			1 Caja
		</option>
		<option value='2'>
			2 Cajas
		</option>		
		<option value='3'>
			3 Cajas
		</option>
		<option value='4'>
			4 Cajas
		</option>				
		<option value='5'>
			5 Cajas
		</option>
		<option value='6'>
			6 Cajas
		</option>		
		<option value='7'>
			7 Cajas
		</option>
		<option value='8'>
			8 Cajas
		</option>						
		<option value='9' selected='selected'>
			9 Cajas
		</option>								
	</select>
	<button id='boton_cajas' style='font-size:1em;'>
		Aceptar
	</button>
</div>
<div id='inicio' style='text-align:center'>
	<br />
	<br />	
	<p>
		<img src='images/logocadem.png' style='height:75%;width:75%' />					
	</p>
	<p>
		<h2>
			Cuestionario PSA
		</h2>
		<h3>
			Espere unos momentos mientras se cargan los datos...
		</h3>
	</p>
	<p>
		<img src='images/redbull-logo.jpg'/>					
	</p>
</div>
<div id='fin' style='text-align:center;display:none'>
	<br />
	<br />	
	<p>
		<img src='images/logocadem.png' style='height:75%;width:75%' />					
	</p>
	<p>
		<h2>
			Cuestionario PSA
		</h2>
		<h3>
			Sesión finalizada. Para realizar una nueva visita cierre y vuelva a abrir el programa.
		</h3>
	</p>
	<p>
		<img src='images/redbull-logo.jpg'/>					
	</p>
</div>
</html>