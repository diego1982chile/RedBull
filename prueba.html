<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
<link href="css/jquery-ui-1.10.2.custom.min.css" rel="stylesheet" />
<link href="css/jquery.mobile-1.3.1.min.css" rel="stylesheet" />

<style>
	
	table tr td{
		text-align: center;
		font-family: "Arial",Georgia,Serif;
		
	}	
	h4,h5,div,table{
		padding:0em;
		margin:0em;
	}
	.seleccionada{
		background:blue;
		color:white;
	}
	
</style>

<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>

<script type="text/javascript" src="js/taffy.js"></script>
<script type="text/javascript" src="js/json2.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.10.2.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="js/jquery.ui.touch-punch.min.js"></script>

<script>

/**
 * Very simple way to check if a file exists on this domain.
 * Use with the jQuery library.
 *
 * Important: 	Works only on the same domain. 
 * 		Cross-domain-requests have to be done in another way (see JSONP)!
 *
 * Use: console.log(   "/data/list.json".fileExists()  );
 */
String.prototype.fileExists = function() {
	filename = this;
	
	var response = jQuery.ajax({
		url: filename,
		type: 'HEAD',
		async: false
	}).status;	
	
	return (response != "200") ? false : true;
}

	// Indice comienza en 1
	
		var cursor=1;
        var id_respuesta=1;
		var id_toma=1;			
        
		// Estas variables se usan para identificar el archivo con la toma
		var codigo_auditor;
		var folio_sala;
		
        var preguntasDB;
        var seccionesDB;		
        var topicosDB;        
        var categoriasDB;									
        var preguntas_categoriasDB;											
        var itemesDB;								
        var alternativasDB;	    	

		// var pathCuestionario="cuestionario.txt"
		var pathCuestionario="\\Application\\cuestionario.txt";
		
	function respuesta(id_respuesta,valor_respuesta,id_item,id_pregunta,id_categoria)
	{
            this.id_respuesta=id_respuesta;
            this.valor_respuesta=valor_respuesta;               
            this.id_item=id_item;
            this.id_pregunta=id_pregunta;	
            this.id_categoria=id_categoria;
	}	
	
	function toma(fecha_toma,estado_toma,id_auditor,id_sala,respuestas)
	{		
		this.fecha_toma=fecha_toma;
		this.estado_toma=estado_toma;		
		this.id_auditor=id_auditor;
		this.id_sala=id_sala;
		this.respuestas=respuestas;
	}	

	var respuestas= new Array();

	var respuestasDB= TAFFY(respuestas); 			

	// Carga de datos en los contenedores de objetos
	
	function cargar_datos()
	{								
		// cargar_respuestas();
			$.getJSON('data/topicos.txt',function(data){					
				topicosDB=TAFFY(data);
				$.getJSON('data/secciones.txt',function(data){
					seccionesDB=TAFFY(data);
					$.getJSON('data/categorias.txt',function(data){
						categoriasDB=TAFFY(data);
						$.getJSON('data/preguntas.txt',function(data){			
							preguntasDB=TAFFY(data);	
							$.getJSON('data/preguntas_categorias.txt',function(data){
								preguntas_categoriasDB=TAFFY(data);
								$.getJSON('data/itemes.txt',function(data){
									itemesDB=TAFFY(data);
									$.getJSON('data/alternativas.txt',function(data){
										alternativasDB=TAFFY(data);									
										cargar_contenido(cursor);	
										$('#cuestionario').dataTable({
											"sScrollY": "520px",		 		 		
											"bFilter": false,
											"bSort": false,
											"bInfo": false,
											"bPaginate": false,
											"bJQueryUI": false,
											"bAutoWidth": false, 		
										});										
									});									
								});	
							});		
						});	
					});	
				});				
			});				
	}
	
	// Carga de datos en los contenedores de objetos
	
		function cargar_auditores()
		{										
									
			var xmlhttp;
			if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari				
				xmlhttp=new XMLHttpRequest();				
			}
			else{// code for IE6, IE5				
				xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");				
			}
																	
			xmlhttp.onreadystatechange=function(){
													
				if (xmlhttp.readyState==4 && xmlhttp.status==200)
				{									
					var data = JSON.parse(xmlhttp.responseText);											
					
					var html="<table id='tabla_auditores' width='100%'><thead><tr><th>Seleccione auditor</th></tr></thead><tbody>";
				
					$(data).each(function(key,value){															
						html=html+"<tr><td><button id_auditor="+value.id_auditor+" codigo_auditor="+value.codigo_auditor+" class='auditor' style='width=400px'><label style='font-size:2em'>"+value.nombre_auditor+"</label></button></td></tr>";
					});
					html=html+"</tbody></table>";
					// alert(html);					
					$('#auditores').html(html);
					$('#tabla_auditores').dataTable({
						"sScrollY": "215px",		 		 		
						"bFilter": true,
						"bSort": false,
						"bInfo": false,
						"bPaginate": false,
						"bJQueryUI": true,
						"bAutoWidth": false, 		
					});			
					
					$('.auditor').click(function(){											
						
						$('#salas').html('Cargando salas...');
						$('.ui-state-active').removeClass();
						$(this).addClass('ui-state-active');
					
						codigo_auditor=$(this).attr('codigo_auditor');
						var id_auditor=$(this).attr('id_auditor');
					
						var xmlhttp;
						if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari				
							xmlhttp=new XMLHttpRequest();				
						}
						else{// code for IE6, IE5							
							xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");				
						}												
											
						xmlhttp.onreadystatechange=function(){												
													
							if (xmlhttp.readyState==4 && xmlhttp.status==200)
							{																	
								var data = JSON.parse(xmlhttp.responseText);	
								
								if($.isEmptyObject(data))
								{
									alert("No existen salas asignadas para este auditor");
									$('#salas').html('');
								}
								else
								{
									var html="<table id='tabla_salas' width='100%'><thead><tr><th>Seleccione sala</th></tr></thead><tbody>";
							
									$(data).each(function(key,value){																			
										html=html+"<tr title='"+value.direccion+"'><td><button class='sala' folio_sala="+value.folio+" style='width=400px'><label style='font-size:1.5em'>"+value.folio+"/"+value.calle+"-"+value.numero+"</label></button></td></tr>";									
									});
									html=html+"</tbody></table>";
		
									$('#loader').hide();
									$('#salas').html(html);
								
									$('#tabla_salas').dataTable({
										"sScrollY": "215px",		 		 		
										"bFilter": true,
										"bSort": false,
										"bInfo": false,
										"bPaginate": false,
										"bJQueryUI": true,
										"bAutoWidth": false, 																				
									});

									$('.sala').click(function(){
										
										folio_sala=$(this).attr('folio_sala');
										
										pathCuestionario="\\Application\\toma"+codigo_auditor+folio_sala+".txt";
										
										$('#sesion').hide(),
										$('#container').show();
										// cargar_datos();
										
										if(pathCuestionario.fileExists())
										{									
											$.getJSON(pathCuestionario,function(data){					
											respuestasDB=TAFFY(data.respuestas);
												if(parseInt(toma.estado)==1)
												{																														
													if(confirm("Esta sesión corresponde a una toma pendiente en este equipo. ¿Desea cargar los datos de esta toma?"))
														cargar_datos();
												}
												else
												{
													if(confirm("Esta sesión corresponde a una toma completada en este equipo. ¿Desea cargar los datos de esta toma?"))
														cargar_datos();
												}												
											});		
										}	
										else
										{
											alert("Esta sesión corresponde a una nueva toma. Se cargará el cuestionario");
											cargar_datos();
										}										
									});
								}																										
							}
						}						
						xmlhttp.open("GET","http://200.29.139.244/REDBULL/php/cargar_maestra.php?caso=2&id_auditor='"+id_auditor+"'",true);
						xmlhttp.send();	
					});						
				}
			}
			xmlhttp.open("GET",'http://200.29.139.244/REDBULL/php/cargar_maestra.php?caso=1',true);
			xmlhttp.send();			
		}
	
	// Carga el contenido desde objetos 'consultables' a partir de los contenedores
	
    function cargar_contenido(id_pregunta)
    {					     			
		// alert('voy a cargar el contenido');
        // Filtrar preguntas por id_pregunta segun cursor actual		
        preguntasDB().filter({'id_pregunta':id_pregunta}).each(function (r1) { 

            seccionesDB().filter({'id_seccion':r1.id_seccion}).each(function (r2) { 

                topicosDB().filter({'id_topico':r2.id_topico}).each(function (r3) { 

                    $('#topico').html("<h5 style='color:"+r3.color_letra+"'>"+r3.numero_topico+'. '+r3.nombre_topico+"<h5>");
                    $('#topico').css('background-color',r3.color_topico);

                    $('#seccion').html("<h5>"+r3.numero_topico+'.'+r2.numero_seccion+' '+r2.nombre_seccion+"</h5>");
                    $('#seccion').css('background-color',r2.color_seccion);					

                    $('#pregunta').html("<h5 style='padding:0em'>"+r3.numero_topico+'.'+r2.numero_seccion+'.'+r1.numero_pregunta+' '+r1.contenido_pregunta+"</h5>");

                    switch(parseInt(r1.tipo))
                    {
                        case 1:// Tipo alternativa => cargar las alternativas para esta pregunta
                            // Verificar si existen categorias para esta pregunta	                                                       
							
							var tiene_categoria=false;
                            
							preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function () {
                                tiene_categoria=true;
                                return false;
                            });
																					
							switch(parseInt(r1.tipo2))
							{								
								case 1: // Tipo disyuntiva
									if(tiene_categoria)
									{                      
										var maxCat;
																													
										if(id_pregunta>33)
										{
											respuestasDB().filter({'id_pregunta':33}).each(function(r20){												
												maxCat=parseInt(r20.valor_respuesta);												
											});
										}
										else
										{
											maxCat=15;
										}										
									
										var html="<table id='tabla_alternativas' width='100%' border='1' align='left'>";

										var contCat=0;
										
										var flag=false;
										
										preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {	
														
											if(flag)
												return false;
											
											categoriasDB().filter({'id_categoria':r5.id_categoria}).each(function (r6) {
																				
											var cont=0;
											
											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r9){
												cont++;
											});											
											html=html+"<tr><td width='25%' style='text-align:left' rowspan='"+cont+"'>"+r6.nombre_categoria+"</td>";											
											var cont=1;

											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r7) {

											itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {

												if(cont===1)
													html=html+"<td width='75%' style='text-align:left'><input type='radio' id='radio"+cont+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='radio"+r5.id_categoria+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";                                                                                                
												else                                                                                                
													html=html+"<tr id='"+r8.id_item+"'><td item='"+r7.id_item+"' style='text-align:left'><input type='radio' id='radio"+cont+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='radio"+r5.id_categoria+"' value='"+r5.id_categoria+r8.id_item+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";										
											});	
											cont++;
											});	
											contCat++;
											
											if(contCat>=maxCat)																						
												flag=true;																						
										});			
									});	
									html=html+"</table>";                         
									}
									else
									{
										// Si no existen categorias para esta pregunta, cargar directamente las alternativas
										var html="<table id='tabla_alternativas' width='100%' border='1' align='left'>";
										var cont=1;
										alternativasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {					
												cont++;
												itemesDB().filter({'id_item':r5.id_item}).each(function (r6) {									
														html=html+"<tr><td id='"+r6.id_item+"' style='text-align:left'><input type='radio' id='radio"+cont+"' categoria='"+r5.id_categoria+"' item='"+r5.id_item+"' name='radio"+r5.id_categoria+"' value='"+r6.id_item+"' /><label style='font-size:0.9em'>"+r6.nombre_item+"</label></td></tr>";										
												});															
										});		
										html=html+"</table>";									
									}					
									
									// $('#respuesta').css('height',"'"+430-parseInt($('#pregunta').css('height'))+"px'"); 
									$('#respuesta').html(html);   															
									
									// Si existen respuestas buscar las respuestas correspondiente a la pregunta actual y cargarlas
																		
									respuestasDB().filter({'id_pregunta':id_pregunta}).each(function (r10) {											
										$('[name=radio'+r10.id_categoria+']').filter('[categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').prop('checked', true);
										$('[name=radio'+r10.id_categoria+']').filter('[categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').parent().addClass("seleccionada");
									});
									
									$('#tabla_alternativas tr td').click(function(){
										$('[name=radio'+$(this).children().attr('categoria')+']').parent('.seleccionada').removeClass();
										$(this).addClass("seleccionada");                                
										$('[name=radio'+$(this).children().attr('categoria')+']').filter('[categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', true);                                
										guardarRespuesta(id_pregunta,$(this).children().attr('categoria'),$(this).children().attr('item'),null); 																																						
									});													
									break;
								case 2: // Tipo conjuntiva
									if(tiene_categoria)
									{                         										
										var html="<table id='tabla_alternativas' width='100%' border='1' align='left'>";

										preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {

											categoriasDB().filter({'id_categoria':r5.id_categoria}).each(function (r6) {
																				
											var cont=0;
											
											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r9){
												cont++;
											});											
											html=html+"<tr><td width='30%' style='text-align:left' rowspan='"+cont+"'>"+r6.nombre_categoria+"</td>";											
											var cont=1;

											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r7) {

											itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {

												if(cont===1)
													html=html+"<td width='70%' style='text-align:left'><input type='checkbox' id='radio"+cont+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='checkbox' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";                                                                                                
												else                                                                                                
													html=html+"<tr width='50%' id='"+r8.id_item+"'><td item='"+r7.id_item+"' style='text-align:left'><input type='checkbox' id='radio"+cont+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='checkbox' value='"+r5.id_categoria+r8.id_item+"' /><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td></tr>";										
											});	
											cont++;
											});										
										});			
									});	
									html=html+"</table>";                         
									}
									else
									{
										// Si no existen categorias para esta pregunta, cargar directamente las alternativas
										var html="<table id='tabla_alternativas' width='100%' border='1' align='left'>";
										var cont=1;
										alternativasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {					
												cont++;
												itemesDB().filter({'id_item':r5.id_item}).each(function (r6) {									
														html=html+"<tr><td id='"+r6.id_item+"' style='text-align:left'><input type='checkbox' id='radio"+cont+"' categoria='"+r5.id_categoria+"' item='"+r5.id_item+"' name='checkbox' value='"+r6.id_item+"' /><label style='font-size:0.9em'>"+r6.nombre_item+"</label></td></tr>";										
												});															
										});		
										html=html+"</table>";									
									}							
									// $('#respuesta').css('height',"'"+430-parseInt($('#pregunta').css('height'))+"px'"); 
									$('#respuesta').html(html);   															
									
									// Si existen respuestas buscar las respuestas correspondientes a la pregunta actual y cargarlas
																		
									respuestasDB().filter({'id_pregunta':id_pregunta}).each(function (r10) {							
										$('[name=checkbox]').filter('[categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').prop('checked', true);
										$('[name=checkbox]').filter('[categoria="'+r10.id_categoria+'"][item="'+r10.id_item+'"]').parent().addClass("seleccionada");
									});
									
									$('#tabla_alternativas tr td').click(function(){										
										if($(this).children().prop('checked'))
										{
											$(this).removeClass("seleccionada");
											$('[name=checkbox]').filter('[categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', false);											
										}
										else
										{
											$(this).addClass("seleccionada");        											
											$('[name=checkbox]').filter('[categoria="'+$(this).children().attr('categoria')+'"][item="'+$(this).children().attr('item')+'"]').prop('checked', true);
										}										                              
										guardarRespuesta(id_pregunta,$(this).children().attr('categoria'),$(this).children().attr('item'),null); 																											
									});																													
									break;																					                                                     
								case 3: // Tipo conjuntiva con valor	
									var html="";
									
									if(tiene_categoria)
									{                         													
										html=html+"<div><table id='tabla_alternativas' width='100%' border='1' align='left'></div>";

										preguntas_categoriasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {

											categoriasDB().filter({'id_categoria':r5.id_categoria}).each(function (r6) {
																				
											var cont=0;
											
											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r9){
												cont++;
											});											
											html=html+"<tr><td width='20%' style='text-align:left' rowspan='"+cont+"'>"+r6.nombre_categoria+"</td>";											
											var cont=1;

											alternativasDB().filter({'id_categoria':r5.id_categoria},{'id_pregunta':id_pregunta}).each(function (r7) {

											itemesDB().filter({'id_item':r7.id_item}).each(function (r8) {

												if(cont===1)
													html=html+"<td width='50%' style='text-align:left'><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td><td width='20%'><input id='valor"+cont+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='input"+r5.id_categoria+r7.id_item+"' class='valor' /></td></tr>";                                                                                                
												else                                                                                                
													html=html+"<tr width='50%' id='"+r8.id_item+"'><td item='"+r7.id_item+"' style='text-align:left'><label style='font-size:0.9em'>"+r8.nombre_item+"</label></td><td width='20%'><input id='valor"+cont+"' categoria='"+r5.id_categoria+"' item='"+r7.id_item+"' name='input"+r5.id_categoria+r7.id_item+"' class='valor' /></td></tr>";										
											});	
											cont++;
											});										
										});			
									});	
									html=html+"</table>";                         
									}
									else
									{										
										// Si no existen categorias para esta pregunta, cargar directamente las alternativas
										html=html+"<div><table id='tabla_alternativas' width='100%' border='1' align='left'></div>";
										var cont=1;
										alternativasDB().filter({'id_pregunta':id_pregunta}).each(function (r5) {					
												cont++;
												itemesDB().filter({'id_item':r5.id_item}).each(function (r6) {									
													html=html+"<tr><td id='"+r6.id_item+"' style='text-align:left' width='50%'><label style='font-size:0.9em'>"+r6.nombre_item+"</label></td><td width='20%'><input id='valor"+cont+"' categoria='"+r5.id_categoria+"' item='"+r5.id_item+"' name='input"+r5.id_categoria+r5.id_item+"' class='valor' /></td></tr>";										
												});															
										});		
										html=html+"</table>";									
									}						
									html=html+"<div style='height:60px'><table width='100%'><tr><td width='16%'><button val='1' class='teclado'>1</button></td><td width='16%'><button val='2' class='teclado'>2</button></td><td width='16%'><button val='3' class='teclado'>3</button></td><td width='16%'><button val='4' class='teclado'>4</button></td><td width='16%'><button val='5' class='teclado'>5</button></td><td width='16%' rowspan='2'><button class='borrar'><-</button></td></tr><tr><td><button val='6' class='teclado'>6</button></td><td><button val='7' class='teclado'>7</button></td><td><button val='8' class='teclado'>8</button></td><td><button val='9' class='teclado'>9</button></td><td><button val='0' class='teclado'>0</button></td></tr><table></div>";									
									// $('#respuesta').html(html); 
									// $('#respuesta').css('height',"'"+430-parseInt($('#pregunta').css('height'))+"px'"); 
									$('#respuesta').html(html);
																											
									// Si existen respuestas buscar las respuestas correspondientes a la pregunta actual y cargarlas
																		
									respuestasDB().filter({'id_pregunta':id_pregunta}).each(function (r10) {											
										$('[name=input'+r10.id_categoria+r10.id_item+']').val(r10.valor_respuesta);
									});
									
									$('#valor').css('font-size','20px');
									$('.teclado').css('font-size','15px');
									$('.teclado').css('width','100%');
									$('.borrar').css('width','100%');
									$('.borrar').css('font-size','15px');
									$('input').css('width','100%');
									
									var categoria=$('.valor:first').attr('categoria');
									var item=$('.valor:first').attr('item');
									
									$('[categoria='+categoria+'][item='+item+']').focus();
									
									$('.valor').focusin(function(){
										categoria=$(this).attr('categoria');
										item=$(this).attr('item');
									});										
									
									$('.teclado').click(function(){												
										$('[categoria='+categoria+'][item='+item+']').val( parseInt($('[categoria='+categoria+'][item='+item+']').val()+$(this).attr('val'))); 										
										if($('[categoria="'+categoria+'"][item="'+item+'"]').val()!='')																																		
											guardarRespuesta(id_pregunta,categoria,item,$('[categoria='+categoria+'][item='+item+']').val());										
									});
									
									$('.borrar').click(function(){								
										$('[categoria='+categoria+'][item='+item+']').val(''); 										
									});																																					                           																			
									break;		
							}
                            break;							
                        case 2:// Tipo numerico => cargar un input                                                        
                            var html="<div style='height:50px'><input id='valor' /></div><div style='height:100px'><table width='100%'><tr><td width='33%'><button val='7' class='teclado'>7</button></td><td width='33%'><button val='8' class='teclado'>8</button></td><td width='33%'><button val='9' class='teclado'>9</button></td></tr><tr><td><button val='4' class='teclado'>4</button></td><td><button val='5' class='teclado'>5</button></td><td><button val='6' class='teclado'>6</button></td></tr><tr><td><button val='1' class='teclado'>1</button></td><td><button val='2' class='teclado'>2</button></td><td><button val='3' class='teclado'>3</button></td></tr><tr><td colspan='2'><button val='0' class='teclado'>0</button></td><td><button val='0' class='borrar'><-</button></td></tr><table></div>";
                            $('#respuesta').html(html);
							// $('button').button();
							// $('button').css('padding','0em');
							// $('span').css('padding','0em');
							// Si existen respuestas buscar las respuestas correspondiente a la pregunta actual y cargarlas
																		
							respuestasDB().filter({'id_pregunta':id_pregunta}).each(function (r10) {							
								$('#valor').val(r10.valor_respuesta);								
							});
							
                            $('#valor').css('font-size','20px');
                            $('.teclado').css('font-size','15px');
                            $('.teclado').css('width','100%');
							$('.borrar').css('width','100%');
							$('.borrar').css('font-size','15px');
                            
							$('.teclado').click(function(){								
                                $('#valor').val( parseInt($('#valor').val()+$(this).attr('val')));  
								if($('#valor').val()!='')									
									guardarRespuesta(id_pregunta,null,null,$('#valor').val());
                            });
							
							$('.borrar').click(function(){								
                                $('#valor').val(''); 										
                            });							
                            break;				
                    }						
                });
            });
        });
    }
	
    function guardarRespuesta(id_pregunta,id_categoria,id_item,valor)    
    {		
        var existeRespuesta=false;
        var tipoPregunta;		       
		
		preguntasDB().filter({'id_pregunta':id_pregunta}).each(function (r0) {
            tipoPregunta=r0.tipo2;
            return false;
        });		
		
		switch(parseInt(tipoPregunta))
		{
			case 1: // TIPO DISYUNTIVA -> Buscar si existe la misma: pregunta y categoria			
				respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':id_categoria}).each(function () {
					existeRespuesta=true;
					return false;
				});							
				if(existeRespuesta)// Si existe la respuesta, actualizarla
				{
					respuestasDB({'id_pregunta':id_pregunta,'id_categoria':id_categoria}).update({valor_respuesta:valor,id_item:id_item,id_categoria:id_categoria});
				}
				else // Sino existe la respuesta, agregarla		
				{
					respuestasDB.insert(new respuesta(id_respuesta,valor,id_item,id_pregunta,id_categoria));              
					id_respuesta++;
				}
				break;
			case 2: // TIPO CONJUNTIVA => Buscar si existe la misma: pregunta, categoria e item
				respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':id_categoria,'id_item':id_item}).each(function () {
					existeRespuesta=true;
					return false;
				});						
				if(existeRespuesta)  // Si existe la respuesta, eliminarla
				{ 					
					respuestasDB({'id_pregunta':id_pregunta,'id_categoria':id_categoria,'id_item':id_item}).remove();
					id_respuesta--;
				}
				else // Sino existe la respuesta, agregarla
				{
					respuestasDB.insert(new respuesta(id_respuesta,valor,parseInt(id_item),parseInt(id_pregunta),parseInt(id_categoria)));              
					id_respuesta++;
				}				
				break;		
			case 3:
				respuestasDB().filter({'id_pregunta':id_pregunta,'id_categoria':id_categoria,'id_item':id_item}).each(function () {
					existeRespuesta=true;
					return false;
				});
				if(existeRespuesta)// Si existe la respuesta, actualizarla
				{
					respuestasDB({'id_pregunta':id_pregunta,'id_categoria':id_categoria,'id_item':id_item}).update({valor_respuesta:valor,id_item:id_item,id_categoria:id_categoria});
				}
				else // Sino existe la respuesta, agregarla		
				{
					respuestasDB.insert(new respuesta(id_respuesta,valor,parseInt(id_item),parseInt(id_pregunta),parseInt(id_categoria)));              
					id_respuesta++;
				}				
				break;
				
		}        				
        // respuestasDB().each(function (r1) {
           // console.log(r1); 
        // });
    }				

	function save_content_to_file(content, filename){		
		var dlg = false;
		with(document){
		 ir=createElement('iframe');
		 ir.id='ifr';
		 ir.location='about.blank';
		 ir.style.display='none';
		 body.appendChild(ir);
		
		  with(getElementById('ifr').contentWindow.document){
			   open("text/plain", "replace");
			   charset = "utf-8";
			   write(content);
			   close();
			   document.charset = "utf-8";
			   dlg = execCommand('SaveAs', true, filename);
		   }
		   //body.removeChild(ir);
		 }
		return dlg;
	}	
	
	function validar_cuestionario(){
	
		var ok=true;	
		var flag=false;
	
		preguntasDB().each(function(pregunta){
		
			if(flag)
				return false;
		
			var tieneCategoria=false;			
			var tipo1=parseInt(pregunta.tipo);
			var tipo2=parseInt(pregunta.tipo2);			
			var aux=false;																					
			
			switch(tipo1)
			{
				case 1: //Tipo alternativa
				
				preguntas_categoriasDB().filter({'id_pregunta':pregunta.id_pregunta}).each(function(categoria){
					tieneCategoria=true;
					return false;
				});
				
					switch(tipo2)
					{
						case 1: // Tipo disyuntiva												
						
							if(tieneCategoria)
							{								
								var cont1=1;								
								preguntas_categoriasDB().filter({'id_pregunta':pregunta.id_pregunta}).each(function(categoria){									
									var cont2=0;
									respuestasDB().filter({'id_pregunta':pregunta.id_pregunta,'id_categoria':categoria.id_categoria}).each(function(){
										cont2++;
									});
									cont1=cont1*cont2;
									alert("cont1="+cont1);
								});
								if(cont1!=0) // Para cada categoria debe haber una respuesta
									aux=true; 
							}
							else
							{								
								respuestasDB().filter({'id_pregunta':pregunta.id_pregunta}).each(function(respuesta){
									aux=true;	
									return false;
								});
							}
							break;
						case 2: // Tipo conjuntiva
							if(tieneCategoria)
							{
								var cont=0;
								preguntas_categoriasDB().filter({'id_pregunta':pregunta.id_pregunta}).each(function(categoria){	
<!-- 									alert('soy categoria conjuuntiva');
									alert(JSON.stringify(categoria)); -->
									alert(respuestasDB().filter({'id_pregunta':pregunta.id_pregunta}).stringify());
									respuestasDB().filter({'id_pregunta':pregunta.id_pregunta,'id_categoria':categoria.id_categoria}).each(function(){
										alert('hay respuesta');
										cont++;
										return false;
									});
								});
								if(cont>0) // Para al menos una categoria debe haber una respuesta
									aux=true; 								
							}
							else
							{
								respuestasDB().filter({'id_pregunta':pregunta.id_pregunta}).each(function(respuesta){
									aux=true;	
									return false;
								});
							}
							break;
						case 3: // Tipo conjuntiva con valor
							if(tieneCategoria)
							{
								var cont=0;
								preguntas_categoriasDB().filter({'id_pregunta':pregunta.id_pregunta}).each(function(categoria){									
									respuestasDB().filter({'id_pregunta':pregunta.id_pregunta,'id_categoria':categoria.id_categoria}).each(function(){
										cont++;
										return false;
									});
								});
								if(cont>0) // Para al menos una categoria debe haber una respuesta
									aux=true;
							}
							else
							{
								respuestasDB().filter({'id_pregunta':pregunta.id_pregunta}).each(function(respuesta){
									if(respuesta.valor_respuesta!=null)						
										aux=true;						
								});
							}							
					}
					break;
				case 2: //Tipo valor					
					respuestasDB().filter({'id_pregunta':pregunta.id_pregunta}).each(function(respuesta){
						if(respuesta.valor_respuesta!=null)						
							aux=true;						
					});
					break;
			}
			ok=ok*aux;
			
			if(!ok)
			{								
				alert("La siguiente pregunta no ha sido correctamente respondida");				
				flag=true;
				cursor=pregunta.id_pregunta;
				cargar_contenido(cursor);				
			}
						
		});
		
		if(ok)
		{		
			if(confirm("Encuesta completada correctamente, ¿Confirma el envío de la toma?"))
				enviar_toma();
		}		
		else
		{
			// alert('ups...algo raro paso');
		}
	}
	
	function enviar_toma(){

		var xmlhttp;
			
		if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari				
			xmlhttp=new XMLHttpRequest();				
		}
		else{// code for IE6, IE5				
			xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");				
		}
																
		xmlhttp.onreadystatechange=function(){
										
		if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{									
			var data = JSON.parse(xmlhttp.responseText);											
		
		}
		
		var obj_toma=new toma(new Date(),2,codigo_auditor,folio_sala,respuestasDB().get());		
		
		xmlhttp.open("POST",'http://200.29.139.244/REDBULL/php/ingresar_toma.php?toma='+obj_toma,true);
		xmlhttp.send();
		}
	}
	
$(document).ready(function() {		

	$('button').button();
	$('button').css('padding','0em');
	$('span').css('padding','0em');	
	cargar_auditores();
		
	$('#guardar').click(function(){		
		
		var obj_toma=new toma(new Date(),1,codigo_auditor,folio_sala,respuestasDB().get());			
		
		save_content_to_file(JSON.stringify(obj_toma), pathCuestionario);
	});
	
	$('.cursor').click(function(){			
	
		$(this).addClass('ui-state-active');
	
		if($(this).attr('id')==='ant')
		{
            if(cursor>1)							
                cursor--;
		}
		else
		{
            if(cursor<42)							
                cursor++;
		}				
		
		cargar_contenido(cursor);		
		
		$(this).removeClass('ui-state-active');
	});
	
	$('#enviar').click(function(){
		validar_cuestionario();
	});
	
	$('button').selectable();
	
});
</script>
</head>
<body>

<div id="container" style="width:100%;display:none;">

    <table id='cuestionario' width='100%' class='display table' border=1>
		<thead>
		<tr style="background-color:#000000">
			<th style='vertical-align:middle'>
					<h4 style="color:#FFFFFF;">
							CUESTIONARIO PSA
					</h4>
			</th>
		</tr>
		<thead>
		<tbody>
		<tr>
			<td id='topico' style='vertical-align:middle'>
					<h4 style="background-color:#000000;">
							Cargando...
					</h4>			
			</td>
		</tr>		
		<tr>
			<td id='seccion' style='vertical-align:middle'>
					<h4>
							Cargando...
					</h4>			
			</td>
		</tr>		
		<tr>
			<td id='pregunta' style='height:100px;' style='vertical-align:middle'>
					<h4>
							Cargando...
					</h4>
			</td>
		</tr>				
		<tr>
			<td id='respuesta' style='vertical-align:top'>				
						<h4>
								Cargando...
						</h4>
			</td>		
		</tr>	
		<tbody>
    </table>	
	
    <table width='70%' align='center'>    
        <tr>
            <td width='20%'>
                <button class='cursor' id='ant' style='padding:0em;margin:0em'>
                    <img src='images/arrow-left.png' style='width:2em;height:1em'/>
                </button>                
				<a class="carousel-control left" href="#selectable-carousel" data-slide="prev">
					<i class="icon-backward icon-white">
					</i>
				</a>
            </td>
            <td width='20%'>
                <button id='guardar' style='width:100%;height:50%'>
                    <img src='images/System-Save-icon.png' style='width:2em;height:1em'/>
                </button>  
            </td>
            <td width='20%'>
                <button id='enviar' style='width:100%;height:50%'>
                    <img src='images/600px-Black_check.svg.png' style='width:2em;height:1em'/>
                </button> 
            </td>
            <td width='20%'>
                <button class='cursor' id='sig' style='padding:0em;margin:0em'>
                    <img src='images/arrow.png' style='width:2em;height:1em'/>
                </button>	
            </td>
        </tr>
    </table>
</div>
<div id="sesion" style="width:100%;">
	<table width='100%'>
			<thead>
            <tr style="background-color:#000000">
                    <th style='vertical-align:middle'>
						<h4 style="color:#FFFFFF;">
								Ingreso Usuario
						</h4>
                    </th>
            </tr>
			<thead>
		<tr>
			<td>
				<div id='auditores'>
					<h1>
						Cargando auditores...
					</h1>
				</div>
			</td>
		</tr>
		<tr>
			<td>
				<div id='salas'>
				</div>
			</td>
		</tr>
	</table>
</div>
</body>
</html>